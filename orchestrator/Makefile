# ============================================================================
# Makefile - Orchestrator Service
# ============================================================================
# Comandos padronizados para desenvolvimento, testes e deploy
# 
# Uso: make <target>
# Lista de comandos: make help
# ============================================================================

.PHONY: help
.DEFAULT_GOAL := help

# ============================================================================
# VARIÃVEIS
# ============================================================================

DOCKER_COMPOSE := docker compose
SERVICE_NAME := orchestrator
PYTHON := python3
VENV := .venv
VENV_BIN := $(VENV)/bin
VENV_PYTHON := $(VENV_BIN)/python
VENV_PYTEST := $(VENV_BIN)/pytest
API_BASE_URL := http://localhost:8000
PORT ?= 8000

# ============================================================================
# HELP
# ============================================================================

help: ## Mostrar esta mensagem de ajuda
	@echo ""
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘          Orchestrator Service - Comandos DisponÃ­veis           â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | \
		awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-25s\033[0m %s\n", $$1, $$2}'
	@echo ""
	@echo "ðŸ“š Categorias:"
	@echo "  â€¢ Desenvolvimento: install, venv, dev, shell"
	@echo "  â€¢ Testes: test, test-unit, test-integration"
	@echo "  â€¢ Docker: build, up, down, restart, logs, ps"
	@echo "  â€¢ API: health, status, jobs"
	@echo "  â€¢ ManutenÃ§Ã£o: clean, clean-all, validate"
	@echo ""

# ============================================================================
# DESENVOLVIMENTO
# ============================================================================

venv: ## Criar virtual environment (.venv)
	@echo "ðŸ Criando virtual environment..."
	@if [ ! -d "$(VENV)" ]; then \
		$(PYTHON) -m venv $(VENV); \
		echo "âœ… Virtual environment criado: $(VENV)"; \
		echo "ðŸ’¡ Ativar: source $(VENV)/bin/activate"; \
	else \
		echo "âœ… Virtual environment jÃ¡ existe: $(VENV)"; \
	fi

install: venv ## Instalar dependÃªncias Python no venv
	@echo "ðŸ“¦ Instalando dependÃªncias no venv..."
	$(VENV_PYTHON) -m pip install --upgrade pip
	$(VENV_PYTHON) -m pip install -r requirements.txt
	@echo "âœ… DependÃªncias instaladas!"

dev: ## Rodar serviÃ§o em modo desenvolvimento (local, sem Docker)
	@echo "ðŸš€ Iniciando $(SERVICE_NAME) em modo dev..."
	@echo "   Port: $(PORT)"
	PORT=$(PORT) $(VENV_PYTHON) run.py

shell: ## Abrir shell Python com ambiente configurado
	@echo "ðŸ Abrindo Python shell..."
	$(VENV_PYTHON)

# ============================================================================
# TESTES
# ============================================================================

test: ## Rodar todos os testes
	@echo "ðŸ§ª Rodando todos os testes..."
	$(VENV_PYTEST) tests/ -v

test-unit: ## Rodar apenas testes unitÃ¡rios
	@echo "ðŸ§ª Rodando testes unitÃ¡rios..."
	$(VENV_PYTEST) tests/unit/ -v

test-integration: ## Rodar testes de integraÃ§Ã£o
	@echo "ðŸ§ª Rodando testes de integraÃ§Ã£o..."
	$(VENV_PYTEST) tests/integration/ -v

test-coverage: ## Rodar testes com coverage
	@echo "ðŸ“Š Rodando testes com coverage..."
	$(VENV_PYTEST) tests/ --cov=modules --cov-report=html --cov-report=term

# ============================================================================
# DOCKER
# ============================================================================

build: ## Build das imagens Docker
	@echo "ðŸ”¨ Building $(SERVICE_NAME)..."
	$(DOCKER_COMPOSE) build --no-cache

up: ## Subir containers
	@echo "ðŸš€ Iniciando $(SERVICE_NAME)..."
	$(DOCKER_COMPOSE) up -d
	@echo "âœ… $(SERVICE_NAME) iniciado!"
	@echo "ðŸ“Š Verifique: make logs"

down: ## Derrubar containers
	@echo "ðŸ›‘ Parando $(SERVICE_NAME)..."
	$(DOCKER_COMPOSE) down
	@echo "âœ… $(SERVICE_NAME) parado!"

restart: down up ## Reiniciar containers

logs: ## Ver logs do serviÃ§o
	@$(DOCKER_COMPOSE) logs -f

ps: ## Listar containers
	@$(DOCKER_COMPOSE) ps

# ============================================================================
# API
# ============================================================================

health: ## Verificar health do serviÃ§o
	@echo "ðŸ¥ Verificando health..."
	@curl -s $(API_BASE_URL)/health | python3 -m json.tool || echo "âŒ ServiÃ§o nÃ£o disponÃ­vel"

jobs: ## Listar jobs em execuÃ§Ã£o
	@echo "ðŸ“‹ Jobs ativos:"
	@curl -s $(API_BASE_URL)/jobs | python3 -m json.tool || echo "âŒ API offline"

status: ## Ver status completo
	@echo "ðŸ“Š Status do $(SERVICE_NAME):"
	@echo ""
	@echo "Containers:"
	@$(DOCKER_COMPOSE) ps
	@echo ""
	@echo "Health:"
	@curl -s $(API_BASE_URL)/health | python3 -m json.tool 2>/dev/null || echo "âŒ API offline"
	@echo ""
	@echo "Jobs:"
	@curl -s $(API_BASE_URL)/jobs 2>/dev/null | python3 -c "import sys, json; data=json.load(sys.stdin); print(f'Total: {len(data.get(\"jobs\", []))}');" 2>/dev/null || echo "N/A"

# ============================================================================
# MANUTENÃ‡ÃƒO
# ============================================================================

clean: ## Limpar arquivos temporÃ¡rios
	@echo "ðŸ§¹ Limpando arquivos temporÃ¡rios..."
	rm -rf __pycache__ modules/__pycache__
	rm -rf .pytest_cache
	rm -rf .coverage htmlcov
	@echo "âœ… Limpeza concluÃ­da!"

clean-all: clean ## Limpar tudo
	@echo "ðŸ§¹ Limpeza TOTAL..."
	@echo "âœ… Limpeza total concluÃ­da!"

clean-docker: ## Limpar imagens Docker
	@echo "ðŸ§¹ Limpando imagens Docker..."
	docker rmi -f $(SERVICE_NAME)-orchestrator 2>/dev/null || true
	@echo "âœ… Imagens removidas!"

validate: ## Validar configuraÃ§Ã£o
	@echo "âœ… Validando $(SERVICE_NAME)..."
	@echo "Checando docker-compose.yml..."
	@$(DOCKER_COMPOSE) config > /dev/null && echo "âœ… docker-compose.yml vÃ¡lido"
	@echo "Checando .env..."
	@test -f .env && echo "âœ… .env existe" || echo "âš ï¸  .env nÃ£o encontrado"
	@echo "Checando Dockerfile..."
	@test -f Dockerfile && echo "âœ… Dockerfile existe" || echo "âŒ Dockerfile nÃ£o encontrado"
	@echo "Checando requirements.txt..."
	@test -f requirements.txt && echo "âœ… requirements.txt existe" || echo "âŒ requirements.txt nÃ£o encontrado"
	@echo "Checando main.py..."
	@test -f main.py && echo "âœ… main.py existe" || echo "âŒ main.py nÃ£o encontrado"

# ============================================================================
# UTILITÃRIOS
# ============================================================================

shell-container: ## Shell no container
	@docker exec -it $(SERVICE_NAME) /bin/bash

notebook: ## Abrir Jupyter notebook de testes
	@echo "ðŸ““ Abrindo notebook..."
	$(VENV_PYTHON) -m jupyter notebook test_orchestrator.ipynb

test-sse: ## Testar SSE (Server-Sent Events) - abre HTML client
	@echo "ðŸŒ Abra test_sse_client.html no navegador"
	@echo "   Arquivo: $(PWD)/test_sse_client.html"
	@which xdg-open > /dev/null && xdg-open test_sse_client.html || echo "Abra manualmente"
