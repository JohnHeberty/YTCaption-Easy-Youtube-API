<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Voice API - Full Control Panel</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéõÔ∏è</text></svg>">
    <style>
        :root {
            --bg: #0d1117; --card: #161b22; --border: #30363d;
            --text: #c9d1d9; --text-dim: #8b949e;
            --blue: #58a6ff; --green: #3fb950; --red: #f85149; --yellow: #d29922;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); padding: 20px; }
        .container { max-width: 1600px; margin: 0 auto; }
        header { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 20px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        h1 { font-size: 20px; color: var(--blue); }
        .badge { background: var(--green); color: #000; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 600; }
        .tabs { display: flex; gap: 8px; border-bottom: 1px solid var(--border); margin-bottom: 20px; }
        .tab { background: none; border: none; color: var(--text-dim); padding: 12px 16px; cursor: pointer; border-bottom: 2px solid transparent; font-size: 13px; }
        .tab:hover { color: var(--text); background: rgba(255,255,255,0.05); }
        .tab.active { color: var(--blue); border-bottom-color: var(--blue); }
        .content { display: none; }
        .content.active { display: block; }
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 6px; padding: 20px; margin-bottom: 16px; }
        .card h2 { font-size: 16px; margin-bottom: 16px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; }
        .form-group { margin-bottom: 14px; }
        label { display: block; margin-bottom: 4px; font-size: 13px; color: var(--text-dim); font-weight: 500; }
        input, textarea, select { width: 100%; padding: 8px; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; color: var(--text); font-size: 13px; }
        textarea { resize: vertical; min-height: 100px; font-family: inherit; }
        button { background: var(--blue); color: #fff; border: none; padding: 8px 16px; border-radius: 4px; font-size: 13px; cursor: pointer; font-weight: 600; }
        button:hover { opacity: 0.9; }
        button:disabled { background: var(--border); cursor: not-allowed; }
        .btn-sm { padding: 4px 10px; font-size: 12px; }
        .btn-success { background: var(--green); color: #000; }
        .btn-danger { background: var(--red); }
        .btn-secondary { background: var(--card); border: 1px solid var(--border); color: var(--text); }
        .msg { padding: 10px; border-radius: 4px; margin-bottom: 12px; font-size: 13px; display: none; }
        .msg.show { display: block; }
        .msg.success { background: rgba(63,185,80,0.15); border: 1px solid var(--green); color: var(--green); }
        .msg.error { background: rgba(248,81,73,0.15); border: 1px solid var(--red); color: var(--red); }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid var(--border); }
        th { color: var(--text-dim); font-weight: 600; }
        tr:hover { background: rgba(255,255,255,0.03); }
        .status { display: inline-block; padding: 3px 8px; border-radius: 10px; font-size: 10px; font-weight: 600; }
        .status.completed { background: rgba(63,185,80,0.2); color: var(--green); }
        .status.processing { background: rgba(88,166,255,0.2); color: var(--blue); }
        .status.failed { background: rgba(248,81,73,0.2); color: var(--red); }
        pre { background: var(--bg); border: 1px solid var(--border); border-radius: 4px; padding: 12px; overflow-x: auto; font-size: 12px; }
        code { font-family: 'Courier New', monospace; }
        .slider { width: 100%; }
        .slider-val { color: var(--blue); font-weight: 600; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéõÔ∏è Audio Voice API - Full Control Panel</h1>
            <span class="badge" id="status">‚óè Online</span>
        </header>

        <div class="tabs">
            <button class="tab active" onclick="showTab('tts')">üé§ TTS</button>
            <button class="tab" onclick="showTab('voices')">üë§ Voices</button>
            <button class="tab" onclick="showTab('jobs')">üìã Jobs</button>
            <button class="tab" onclick="showTab('profiles')">‚öôÔ∏è Quality Profiles</button>
            <button class="tab" onclick="showTab('rvc')">üéöÔ∏è RVC Models</button>
            <button class="tab" onclick="showTab('admin')">üîß Admin</button>
        </div>

        <!-- TTS TAB -->
        <div id="tab-tts" class="content active">
            <div class="card">
                <h2>Create TTS Job</h2>
                <div id="tts-msg" class="msg"></div>
                <div class="form-group">
                    <label>Text *</label>
                    <textarea id="tts-text">Ol√°, tudo bem? Este √© um teste de s√≠ntese de fala em portugu√™s brasileiro.</textarea>
                </div>
                <div class="grid">
                    <div class="form-group">
                        <label>Source Language *</label>
                        <select id="tts-lang">
                            <option value="pt-BR">Portugu√™s BR</option>
                            <option value="en-US">English US</option>
                            <option value="es">Espa√±ol</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Mode *</label>
                        <select id="tts-mode">
                            <option value="dubbing">Generic Voice (dubbing)</option>
                            <option value="dubbing_with_clone">Cloned Voice</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Voice Preset</label>
                        <select id="tts-preset">
                            <option value="female_generic">Female Generic</option>
                            <option value="male_generic">Male Generic</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Voice ID (if cloned)</label>
                        <select id="tts-voice-id"><option value="">None</option></select>
                    </div>
                    <div class="form-group">
                        <label>TTS Engine</label>
                        <select id="tts-engine">
                            <option value="f5tts">F5-TTS (High Quality)</option>
                            <option value="xtts">XTTS (Fast)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Quality Profile</label>
                        <select id="tts-profile">
                            <option value="">Default</option>
                        </select>
                    </div>
                </div>
                <button onclick="createTTSJob()">Create Job</button>
                <div id="tts-result" style="display:none; margin-top: 16px;">
                    <p>Job ID: <code id="tts-job-id"></code></p>
                    <p id="tts-status">Processing...</p>
                    <audio id="tts-audio" controls style="width: 100%; margin-top: 12px; display: none;"></audio>
                </div>
            </div>
        </div>

        <!-- VOICES TAB -->
        <div id="tab-voices" class="content">
            <div class="grid">
                <div class="card">
                    <h2>Clone Voice</h2>
                    <div id="voice-msg" class="msg"></div>
                    <div class="form-group">
                        <label>Audio File *</label>
                        <input type="file" id="voice-file" accept="audio/*">
                    </div>
                    <div class="form-group">
                        <label>Name *</label>
                        <input type="text" id="voice-name" placeholder="Jo√£o Silva">
                    </div>
                    <div class="form-group">
                        <label>Language *</label>
                        <input type="text" id="voice-lang" value="pt-BR">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" id="voice-desc" placeholder="Voz masculina grave">
                    </div>
                    <div class="form-group">
                        <label>Reference Text</label>
                        <textarea id="voice-ref" rows="2"></textarea>
                    </div>
                    <button onclick="cloneVoice()">Clone Voice</button>
                </div>
                <div class="card">
                    <h2>Voice List</h2>
                    <button class="btn-secondary btn-sm" onclick="loadVoices()">üîÑ Refresh</button>
                    <div id="voice-list" style="margin-top: 12px;"></div>
                </div>
            </div>
        </div>

        <!-- JOBS TAB -->
        <div id="tab-jobs" class="content">
            <div class="card">
                <h2>Job Manager</h2>
                <button class="btn-secondary btn-sm" onclick="loadJobs()">üîÑ Refresh</button>
                <table style="margin-top: 12px;">
                    <thead><tr><th>Job ID</th><th>Status</th><th>Engine</th><th>Created</th><th>Actions</th></tr></thead>
                    <tbody id="jobs-tbody"></tbody>
                </table>
            </div>
        </div>

        <!-- QUALITY PROFILES TAB -->
        <div id="tab-profiles" class="content">
            <div class="card">
                <h2>Create Quality Profile</h2>
                <div id="profile-msg" class="msg"></div>
                <div class="grid">
                    <div class="form-group">
                        <label>Engine *</label>
                        <select id="prof-engine" onchange="updateProfileForm()">
                            <option value="xtts">XTTS</option>
                            <option value="f5tts">F5-TTS</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Name *</label>
                        <input type="text" id="prof-name" placeholder="my_custom_profile">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" id="prof-desc" placeholder="Custom settings">
                    </div>
                </div>
                <div id="xtts-params">
                    <h3 style="margin: 16px 0 8px; font-size: 14px;">XTTS Parameters</h3>
                    <div class="grid">
                        <div class="form-group">
                            <label>Temperature: <span class="slider-val" id="val-temp">0.75</span></label>
                            <input type="range" class="slider" id="prof-temp" min="0.1" max="1.0" step="0.05" value="0.75" oninput="updateSlider('temp')">
                        </div>
                        <div class="form-group">
                            <label>Repetition Penalty: <span class="slider-val" id="val-rep">1.5</span></label>
                            <input type="range" class="slider" id="prof-rep" min="1.0" max="5.0" step="0.1" value="1.5" oninput="updateSlider('rep')">
                        </div>
                        <div class="form-group">
                            <label>Top P: <span class="slider-val" id="val-topp">0.9</span></label>
                            <input type="range" class="slider" id="prof-topp" min="0.1" max="1.0" step="0.05" value="0.9" oninput="updateSlider('topp')">
                        </div>
                        <div class="form-group">
                            <label>Top K: <span class="slider-val" id="val-topk">60</span></label>
                            <input type="range" class="slider" id="prof-topk" min="10" max="100" step="5" value="60" oninput="updateSlider('topk')">
                        </div>
                        <div class="form-group">
                            <label>Length Penalty: <span class="slider-val" id="val-len">1.2</span></label>
                            <input type="range" class="slider" id="prof-len" min="0.5" max="2.0" step="0.1" value="1.2" oninput="updateSlider('len')">
                        </div>
                        <div class="form-group">
                            <label>Speed: <span class="slider-val" id="val-speed">1.0</span></label>
                            <input type="range" class="slider" id="prof-speed" min="0.5" max="2.0" step="0.05" value="1.0" oninput="updateSlider('speed')">
                        </div>
                    </div>
                </div>
                <div id="f5tts-params" style="display:none;">
                    <h3 style="margin: 16px 0 8px; font-size: 14px;">F5-TTS Parameters</h3>
                    <div class="grid">
                        <div class="form-group">
                            <label>NFE Steps: <span class="slider-val" id="val-nfe">32</span></label>
                            <input type="range" class="slider" id="prof-nfe" min="8" max="128" step="8" value="32" oninput="updateSlider('nfe')">
                        </div>
                        <div class="form-group">
                            <label>CFG Scale: <span class="slider-val" id="val-cfg">2.0</span></label>
                            <input type="range" class="slider" id="prof-cfg" min="1.0" max="5.0" step="0.1" value="2.0" oninput="updateSlider('cfg')">
                        </div>
                        <div class="form-group">
                            <label>Sway Coefficient: <span class="slider-val" id="val-sway">-1</span></label>
                            <input type="range" class="slider" id="prof-sway" min="-1" max="1.0" step="0.1" value="-1" oninput="updateSlider('sway')">
                        </div>
                        <div class="form-group">
                            <label>Speed: <span class="slider-val" id="val-f5speed">1.0</span></label>
                            <input type="range" class="slider" id="prof-f5speed" min="0.5" max="2.0" step="0.05" value="1.0" oninput="updateSlider('f5speed')">
                        </div>
                    </div>
                </div>
                <button onclick="createProfile()" style="margin-top: 12px;">Create Profile</button>
            </div>
            <div class="card">
                <h2>Existing Profiles</h2>
                <button class="btn-secondary btn-sm" onclick="loadProfiles()">üîÑ Refresh</button>
                <div id="profiles-list" style="margin-top: 12px;"></div>
            </div>
        </div>

        <!-- RVC TAB -->
        <div id="tab-rvc" class="content">
            <div class="card">
                <h2>RVC Models</h2>
                <button class="btn-secondary btn-sm" onclick="loadRVCModels()">üîÑ Refresh</button>
                <div id="rvc-list" style="margin-top: 12px;"></div>
            </div>
        </div>

        <!-- ADMIN TAB -->
        <div id="tab-admin" class="content">
            <div class="grid">
                <div class="card">
                    <h2>Cleanup</h2>
                    <button onclick="cleanup(false)">Basic Cleanup</button>
                    <button class="btn-danger" onclick="cleanup(true)" style="margin-left: 8px;">Deep Cleanup (FLUSH)</button>
                </div>
                <div class="card">
                    <h2>Statistics</h2>
                    <button onclick="loadStats()">Load Stats</button>
                    <pre id="stats" style="margin-top: 12px;"></pre>
                </div>
            </div>
            <div class="card">
                <h2>Health Check</h2>
                <button onclick="healthCheck()">Check Health</button>
                <pre id="health" style="margin-top: 12px;"></pre>
            </div>
        </div>
    </div>

    <script>
        const API = '';
        let pollInterval = null;

        function showTab(name) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('tab-' + name).classList.add('active');
            if (name === 'voices') loadVoices();
            if (name === 'jobs') loadJobs();
            if (name === 'profiles') loadProfiles();
            if (name === 'rvc') loadRVCModels();
        }

        function msg(id, type, text) {
            const el = document.getElementById(id);
            el.className = `msg show ${type}`;
            el.textContent = text;
            setTimeout(() => el.classList.remove('show'), 5000);
        }

        function updateSlider(name) {
            const val = document.getElementById('prof-' + name).value;
            document.getElementById('val-' + name).textContent = val;
        }

        function updateProfileForm() {
            const engine = document.getElementById('prof-engine').value;
            document.getElementById('xtts-params').style.display = engine === 'xtts' ? 'block' : 'none';
            document.getElementById('f5tts-params').style.display = engine === 'f5tts' ? 'block' : 'none';
        }

        async function createTTSJob() {
            const formData = new FormData();
            formData.append('text', document.getElementById('tts-text').value);
            formData.append('source_language', document.getElementById('tts-lang').value);
            formData.append('target_language', document.getElementById('tts-lang').value);
            formData.append('mode', document.getElementById('tts-mode').value);
            formData.append('voice_preset', document.getElementById('tts-preset').value);
            const voiceId = document.getElementById('tts-voice-id').value;
            if (voiceId) formData.append('voice_id', voiceId);
            formData.append('tts_engine', document.getElementById('tts-engine').value);
            const profile = document.getElementById('tts-profile').value;
            if (profile) formData.append('quality_profile_id', profile);

            try {
                const res = await fetch('/jobs', { method: 'POST', body: formData });
                const data = await res.json();
                if (!res.ok) throw new Error(data.detail || 'Error');
                document.getElementById('tts-job-id').textContent = data.job_id;
                document.getElementById('tts-result').style.display = 'block';
                msg('tts-msg', 'success', 'Job created: ' + data.job_id);
                pollJob(data.job_id);
            } catch (e) {
                msg('tts-msg', 'error', e.message);
            }
        }

        async function pollJob(jobId) {
            if (pollInterval) clearInterval(pollInterval);
            pollInterval = setInterval(async () => {
                const res = await fetch('/jobs/' + jobId);
                const job = await res.json();
                document.getElementById('tts-status').textContent = `Status: ${job.status}`;
                if (job.status === 'completed') {
                    clearInterval(pollInterval);
                    const audio = document.getElementById('tts-audio');
                    audio.src = `/jobs/${jobId}/download?format=mp3`;
                    audio.style.display = 'block';
                } else if (job.status === 'failed') {
                    clearInterval(pollInterval);
                    document.getElementById('tts-status').textContent = 'Failed: ' + (job.error || 'Unknown');
                }
            }, 2000);
        }

        async function cloneVoice() {
            const file = document.getElementById('voice-file').files[0];
            if (!file) return msg('voice-msg', 'error', 'Select audio file');
            const formData = new FormData();
            formData.append('file', file);
            formData.append('name', document.getElementById('voice-name').value);
            formData.append('language', document.getElementById('voice-lang').value);
            const desc = document.getElementById('voice-desc').value;
            if (desc) formData.append('description', desc);
            const ref = document.getElementById('voice-ref').value;
            if (ref) formData.append('ref_text', ref);

            try {
                const res = await fetch('/voices/clone', { method: 'POST', body: formData });
                const data = await res.json();
                if (!res.ok) throw new Error(data.detail || 'Error');
                msg('voice-msg', 'success', 'Voice cloning started: ' + data.job_id);
                setTimeout(loadVoices, 10000);
            } catch (e) {
                msg('voice-msg', 'error', e.message);
            }
        }

        async function loadVoices() {
            const res = await fetch('/voices');
            const data = await res.json();
            const list = document.getElementById('voice-list');
            const select = document.getElementById('tts-voice-id');
            if (data.voices.length === 0) {
                list.innerHTML = '<p style="color: var(--text-dim);">No voices</p>';
                select.innerHTML = '<option value="">None</option>';
            } else {
                list.innerHTML = data.voices.map(v => `
                    <div style="background: var(--bg); padding: 12px; border-radius: 4px; margin-bottom: 8px;">
                        <strong>${v.name}</strong> (${v.language})
                        <br><small style="color: var(--text-dim);">ID: ${v.voice_id}</small>
                        <br><button class="btn-danger btn-sm" onclick="deleteVoice('${v.voice_id}')">Delete</button>
                    </div>
                `).join('');
                select.innerHTML = '<option value="">None</option>' + data.voices.map(v => 
                    `<option value="${v.voice_id}">${v.name}</option>`
                ).join('');
            }
        }

        async function deleteVoice(id) {
            if (!confirm('Delete?')) return;
            await fetch('/voices/' + id, { method: 'DELETE' });
            loadVoices();
        }

        async function loadJobs() {
            const res = await fetch('/jobs?limit=50');
            const data = await res.json();
            const tbody = document.getElementById('jobs-tbody');
            if (!data.jobs || data.jobs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No jobs</td></tr>';
            } else {
                tbody.innerHTML = data.jobs.map(j => `
                    <tr>
                        <td><code style="font-size:11px;">${j.job_id.substring(0,20)}...</code></td>
                        <td><span class="status ${j.status}">${j.status}</span></td>
                        <td>${j.tts_engine || '-'}</td>
                        <td style="font-size:11px;">${new Date(j.created_at).toLocaleString()}</td>
                        <td>
                            ${j.status === 'completed' ? `<button class="btn-sm btn-success" onclick="window.open('/jobs/${j.job_id}/download?format=mp3')">‚¨áÔ∏è</button>` : ''}
                            <button class="btn-sm btn-danger" onclick="deleteJob('${j.job_id}')">‚úï</button>
                        </td>
                    </tr>
                `).join('');
            }
        }

        async function deleteJob(id) {
            if (!confirm('Delete?')) return;
            await fetch('/jobs/' + id, { method: 'DELETE' });
            loadJobs();
        }

        async function createProfile() {
            const engine = document.getElementById('prof-engine').value;
            const params = engine === 'xtts' ? {
                temperature: parseFloat(document.getElementById('prof-temp').value),
                repetition_penalty: parseFloat(document.getElementById('prof-rep').value),
                top_p: parseFloat(document.getElementById('prof-topp').value),
                top_k: parseInt(document.getElementById('prof-topk').value),
                length_penalty: parseFloat(document.getElementById('prof-len').value),
                speed: parseFloat(document.getElementById('prof-speed').value),
                enable_text_splitting: false
            } : {
                nfe_step: parseInt(document.getElementById('prof-nfe').value),
                cfg_strength: parseFloat(document.getElementById('prof-cfg').value),
                sway_sampling_coef: parseFloat(document.getElementById('prof-sway').value),
                speed: parseFloat(document.getElementById('prof-f5speed').value)
            };

            try {
                const res = await fetch('/quality-profiles', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: document.getElementById('prof-name').value,
                        description: document.getElementById('prof-desc').value || '',
                        engine: engine,
                        is_default: false,
                        parameters: params
                    })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.detail || 'Error');
                msg('profile-msg', 'success', 'Profile created: ' + data.id);
                loadProfiles();
            } catch (e) {
                msg('profile-msg', 'error', e.message);
            }
        }

        async function loadProfiles() {
            const res = await fetch('/quality-profiles');
            const data = await res.json();
            const list = document.getElementById('profiles-list');
            const select = document.getElementById('tts-profile');
            
            const all = [...data.xtts_profiles, ...data.f5tts_profiles];
            list.innerHTML = all.map(p => `
                <div style="background: var(--bg); padding: 12px; border-radius: 4px; margin-bottom: 8px;">
                    <strong>${p.name}</strong> (${p.engine})
                    <br><small style="color: var(--text-dim);">${p.description || 'No description'}</small>
                    <br><small>ID: ${p.id}</small>
                    ${!p.is_default ? `<br><button class="btn-danger btn-sm" onclick="deleteProfile('${p.engine}','${p.id}')">Delete</button>` : ''}
                </div>
            `).join('');

            select.innerHTML = '<option value="">Default</option>' + all.map(p => 
                `<option value="${p.id}">${p.name} (${p.engine})</option>`
            ).join('');
        }

        async function deleteProfile(engine, id) {
            if (!confirm('Delete?')) return;
            await fetch(`/quality-profiles/${engine}/${id}`, { method: 'DELETE' });
            loadProfiles();
        }

        async function loadRVCModels() {
            const res = await fetch('/rvc-models');
            const data = await res.json();
            const list = document.getElementById('rvc-list');
            if (!data.models || data.models.length === 0) {
                list.innerHTML = '<p style="color: var(--text-dim);">No RVC models</p>';
            } else {
                list.innerHTML = data.models.map(m => `
                    <div style="background: var(--bg); padding: 12px; border-radius: 4px; margin-bottom: 8px;">
                        <strong>${m.name}</strong>
                        <br><small>ID: ${m.model_id}</small>
                    </div>
                `).join('');
            }
        }

        async function cleanup(deep) {
            if (deep && !confirm('DEEP CLEANUP will flush Redis! Continue?')) return;
            const res = await fetch('/admin/cleanup', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ deep: deep })
            });
            const data = await res.json();
            alert(data.message);
        }

        async function loadStats() {
            const res = await fetch('/admin/stats');
            const data = await res.json();
            document.getElementById('stats').textContent = JSON.stringify(data, null, 2);
        }

        async function healthCheck() {
            const res = await fetch('/health');
            const data = await res.json();
            document.getElementById('health').textContent = JSON.stringify(data, null, 2);
        }

        async function checkOnline() {
            try {
                const res = await fetch('/');
                const data = await res.json();
                document.getElementById('status').textContent = '‚óè Online - v' + data.version;
            } catch {
                document.getElementById('status').textContent = '‚óè Offline';
            }
        }

        checkOnline();
        setInterval(checkOnline, 30000);
    </script>
</body>
</html>
