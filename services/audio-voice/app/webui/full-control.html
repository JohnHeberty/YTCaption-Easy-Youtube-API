<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Voice API - Full Control Panel</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéõÔ∏è</text></svg>">
    <style>
        :root {
            --bg: #0d1117; --card: #161b22; --border: #30363d;
            --text: #c9d1d9; --text-dim: #8b949e;
            --blue: #58a6ff; --green: #3fb950; --red: #f85149; --yellow: #d29922;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); padding: 20px; }
        .container { max-width: 1600px; margin: 0 auto; }
        header { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 20px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        h1 { font-size: 20px; color: var(--blue); }
        .badge { background: var(--green); color: #000; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 600; }
        .tabs { display: flex; gap: 8px; border-bottom: 1px solid var(--border); margin-bottom: 20px; }
        .tab { background: none; border: none; color: var(--text-dim); padding: 12px 16px; cursor: pointer; border-bottom: 2px solid transparent; font-size: 13px; }
        .tab:hover { color: var(--text); background: rgba(255,255,255,0.05); }
        .tab.active { color: var(--blue); border-bottom-color: var(--blue); }
        .content { display: none; }
        .content.active { display: block; }
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 6px; padding: 20px; margin-bottom: 16px; }
        .card h2 { font-size: 16px; margin-bottom: 16px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; }
        .form-group { margin-bottom: 14px; }
        label { display: block; margin-bottom: 4px; font-size: 13px; color: var(--text-dim); font-weight: 500; }
        input, textarea, select { width: 100%; padding: 8px; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; color: var(--text); font-size: 13px; }
        textarea { resize: vertical; min-height: 100px; font-family: inherit; }
        button { background: var(--blue); color: #fff; border: none; padding: 8px 16px; border-radius: 4px; font-size: 13px; cursor: pointer; font-weight: 600; }
        button:hover { opacity: 0.9; }
        button:disabled { background: var(--border); cursor: not-allowed; }
        .btn-sm { padding: 4px 10px; font-size: 12px; }
        .btn-success { background: var(--green); color: #000; }
        .btn-danger { background: var(--red); }
        .btn-secondary { background: var(--card); border: 1px solid var(--border); color: var(--text); }
        .msg { padding: 10px; border-radius: 4px; margin-bottom: 12px; font-size: 13px; display: none; }
        .msg.show { display: block; }
        .msg.success { background: rgba(63,185,80,0.15); border: 1px solid var(--green); color: var(--green); }
        .msg.error { background: rgba(248,81,73,0.15); border: 1px solid var(--red); color: var(--red); }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid var(--border); }
        th { color: var(--text-dim); font-weight: 600; }
        tr:hover { background: rgba(255,255,255,0.03); }
        .status { display: inline-block; padding: 3px 8px; border-radius: 10px; font-size: 10px; font-weight: 600; }
        .status.completed { background: rgba(63,185,80,0.2); color: var(--green); }
        .status.processing { background: rgba(88,166,255,0.2); color: var(--blue); }
        .status.failed { background: rgba(248,81,73,0.2); color: var(--red); }
        pre { background: var(--bg); border: 1px solid var(--border); border-radius: 4px; padding: 12px; overflow-x: auto; font-size: 12px; }
        code { font-family: 'Courier New', monospace; }
        .slider { width: 100%; }
        .slider-val { color: var(--blue); font-weight: 600; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéõÔ∏è Audio Voice API - Full Control Panel</h1>
            <span class="badge" id="status">‚óè Online</span>
        </header>

        <div class="tabs">
            <button class="tab active" onclick="showTab('tts')">üé§ TTS</button>
            <button class="tab" onclick="showTab('voices')">üë§ Voices</button>
            <button class="tab" onclick="showTab('jobs')">üìã Jobs</button>
            <button class="tab" onclick="showTab('profiles')">‚öôÔ∏è Quality Profiles</button>
            <button class="tab" onclick="showTab('rvc')">üéöÔ∏è RVC Models</button>
            <button class="tab" onclick="showTab('admin')">üîß Admin</button>
        </div>

        <!-- TTS TAB -->
        <div id="tab-tts" class="content active">
            <div class="card">
                <h2>Create TTS Job</h2>
                <div id="tts-msg" class="msg"></div>
                <div class="form-group">
                    <label>Text *</label>
                    <textarea id="tts-text">Ol√°, tudo bem? Este √© um teste de s√≠ntese de fala em portugu√™s brasileiro.</textarea>
                </div>
                <div class="grid">
                    <div class="form-group">
                        <label>Source Language *</label>
                        <select id="tts-lang">
                            <option value="pt-BR">Portugu√™s BR</option>
                            <option value="en-US">English US</option>
                            <option value="es">Espa√±ol</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Mode *</label>
                        <select id="tts-mode" onchange="updateModeLogic()">
                            <option value="dubbing">Generic Voice (dubbing)</option>
                            <option value="dubbing_with_clone">Cloned Voice</option>
                        </select>
                    </div>
                    <div class="form-group" id="preset-group">
                        <label>Voice Preset</label>
                        <select id="tts-preset">
                            <option value="female_generic">Female Generic</option>
                            <option value="male_generic">Male Generic</option>
                        </select>
                    </div>
                    <div class="form-group" id="voice-id-group" style="display:none;">
                        <label>Voice ID (Cloned) *</label>
                        <select id="tts-voice-id"><option value="">None</option></select>
                    </div>
                    <div class="form-group">
                        <label>TTS Engine</label>
                        <select id="tts-engine" onchange="filterProfilesByEngine()">
                            <option value="f5tts">F5-TTS (High Quality)</option>
                            <option value="xtts">XTTS (Fast)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Quality Profile</label>
                        <select id="tts-profile">
                            <option value="">Default</option>
                        </select>
                    </div>
                </div>
                
                <!-- RVC Section -->
                <div class="card" style="border-left: 3px solid var(--yellow);">
                    <h2>üéöÔ∏è RVC Voice Conversion (Optional)</h2>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="tts-enable-rvc" onchange="toggleRVCOptions()"> 
                            Enable RVC Voice Conversion
                        </label>
                        <small style="color: var(--text-dim); display: block; margin-top: 4px;">
                            Apply voice conversion to transform the generated audio
                        </small>
                    </div>
                    <div id="rvc-options" style="display:none; margin-top: 12px;">
                        <div class="grid">
                            <div class="form-group">
                                <label>RVC Model *</label>
                                <select id="tts-rvc-model">
                                    <option value="">Select model...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Pitch Shift: <span class="slider-val" id="val-pitch">0</span></label>
                                <input type="range" class="slider" id="tts-rvc-pitch" 
                                       min="-12" max="12" value="0" step="1"
                                       oninput="updateSlider('pitch')">
                                <small style="color: var(--text-dim);">-12 to +12 semitones</small>
                            </div>
                        </div>
                        <div class="grid">
                            <div class="form-group">
                                <label>Index Rate: <span class="slider-val" id="val-index-rate">0.75</span></label>
                                <input type="range" class="slider" id="tts-rvc-index-rate" 
                                       min="0" max="1" value="0.75" step="0.05"
                                       oninput="updateSlider('index-rate')">
                                <small style="color: var(--text-dim);">Feature index influence (0-1)</small>
                            </div>
                            <div class="form-group">
                                <label>Filter Radius: <span class="slider-val" id="val-filter">3</span></label>
                                <input type="range" class="slider" id="tts-rvc-filter" 
                                       min="0" max="7" value="3" step="1"
                                       oninput="updateSlider('filter')">
                                <small style="color: var(--text-dim);">Median filtering (0-7)</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button onclick="createTTSJob()">Create Job</button>
                <div id="tts-result" style="display:none; margin-top: 16px;">
                    <p>Job ID: <code id="tts-job-id"></code></p>
                    <p id="tts-status">Processing...</p>
                    <audio id="tts-audio" controls style="width: 100%; margin-top: 12px; display: none;"></audio>
                </div>
            </div>
        </div>

        <!-- VOICES TAB -->
        <div id="tab-voices" class="content">
            <div class="grid">
                <div class="card">
                    <h2>Clone Voice</h2>
                    <div id="voice-msg" class="msg"></div>
                    <div class="form-group">
                        <label>Audio File *</label>
                        <input type="file" id="voice-file" accept="audio/*">
                    </div>
                    <div class="form-group">
                        <label>Name *</label>
                        <input type="text" id="voice-name" placeholder="Jo√£o Silva">
                    </div>
                    <div class="form-group">
                        <label>Language *</label>
                        <input type="text" id="voice-lang" value="pt-BR">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" id="voice-desc" placeholder="Voz masculina grave">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="voice-use-custom-ref" onchange="toggleCustomRef()">
                            Use Custom Reference Text (Override Whisper)
                        </label>
                        <small style="color: var(--text-dim); display: block; margin-top: 4px;">
                            By default, Whisper auto-transcribes the audio. Enable this only if you need to override.
                        </small>
                    </div>
                    <div id="custom-ref-section" style="display:none;">
                        <div class="form-group">
                            <label>Reference Text (Custom Override)</label>
                            <textarea id="voice-ref" rows="2" placeholder="Type the exact text spoken in the audio..."></textarea>
                        </div>
                    </div>
                    <button onclick="cloneVoice()">Clone Voice</button>
                </div>
                <div class="card">
                    <h2>Voice List</h2>
                    <button class="btn-secondary btn-sm" onclick="loadVoices()">üîÑ Refresh</button>
                    <div id="voice-list" style="margin-top: 12px;"></div>
                </div>
            </div>
        </div>

        <!-- JOBS TAB -->
        <div id="tab-jobs" class="content">
            <div class="card">
                <h2>Job Manager</h2>
                <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 12px;">
                    <button class="btn-secondary btn-sm" onclick="loadJobs()">üîÑ Refresh</button>
                    <label style="margin: 0;">
                        Status:
                        <select id="jobs-status-filter" onchange="loadJobs()" style="width: auto; padding: 4px 8px; margin-left: 4px;">
                            <option value="">All</option>
                            <option value="completed">Completed</option>
                            <option value="processing">Processing</option>
                            <option value="failed">Failed</option>
                            <option value="pending">Pending</option>
                        </select>
                    </label>
                    <label style="margin: 0;">
                        Limit:
                        <select id="jobs-limit" onchange="loadJobs()" style="width: auto; padding: 4px 8px; margin-left: 4px;">
                            <option value="20">20</option>
                            <option value="50" selected>50</option>
                            <option value="100">100</option>
                        </select>
                    </label>
                </div>
                <table style="margin-top: 12px;">
                    <thead><tr><th>Job ID</th><th>Status</th><th>Engine</th><th>Created</th><th>Actions</th></tr></thead>
                    <tbody id="jobs-tbody"></tbody>
                </table>
            </div>
        </div>

        <!-- QUALITY PROFILES TAB -->
        <div id="tab-profiles" class="content">
            <div class="card">
                <h2>Create Quality Profile</h2>
                <div id="profile-msg" class="msg"></div>
                <div class="grid">
                    <div class="form-group">
                        <label>Engine *</label>
                        <select id="prof-engine" onchange="updateProfileForm()">
                            <option value="xtts">XTTS</option>
                            <option value="f5tts">F5-TTS</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Name *</label>
                        <input type="text" id="prof-name" placeholder="my_custom_profile">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" id="prof-desc" placeholder="Custom settings">
                    </div>
                </div>
                <div id="xtts-params">
                    <h3 style="margin: 16px 0 8px; font-size: 14px;">XTTS Parameters</h3>
                    <div class="grid">
                        <div class="form-group">
                            <label>Temperature: <span class="slider-val" id="val-temp">0.75</span></label>
                            <input type="range" class="slider" id="prof-temp" min="0.1" max="1.0" step="0.05" value="0.75" oninput="updateSlider('temp')">
                        </div>
                        <div class="form-group">
                            <label>Repetition Penalty: <span class="slider-val" id="val-rep">1.5</span></label>
                            <input type="range" class="slider" id="prof-rep" min="1.0" max="5.0" step="0.1" value="1.5" oninput="updateSlider('rep')">
                        </div>
                        <div class="form-group">
                            <label>Top P: <span class="slider-val" id="val-topp">0.9</span></label>
                            <input type="range" class="slider" id="prof-topp" min="0.1" max="1.0" step="0.05" value="0.9" oninput="updateSlider('topp')">
                        </div>
                        <div class="form-group">
                            <label>Top K: <span class="slider-val" id="val-topk">60</span></label>
                            <input type="range" class="slider" id="prof-topk" min="10" max="100" step="5" value="60" oninput="updateSlider('topk')">
                        </div>
                        <div class="form-group">
                            <label>Length Penalty: <span class="slider-val" id="val-len">1.2</span></label>
                            <input type="range" class="slider" id="prof-len" min="0.5" max="2.0" step="0.1" value="1.2" oninput="updateSlider('len')">
                        </div>
                        <div class="form-group">
                            <label>Speed: <span class="slider-val" id="val-speed">1.0</span></label>
                            <input type="range" class="slider" id="prof-speed" min="0.5" max="2.0" step="0.05" value="1.0" oninput="updateSlider('speed')">
                        </div>
                    </div>
                </div>
                <div id="f5tts-params" style="display:none;">
                    <h3 style="margin: 16px 0 8px; font-size: 14px;">F5-TTS Parameters</h3>
                    <div class="grid">
                        <div class="form-group">
                            <label>NFE Steps: <span class="slider-val" id="val-nfe">32</span></label>
                            <input type="range" class="slider" id="prof-nfe" min="8" max="128" step="8" value="32" oninput="updateSlider('nfe')">
                        </div>
                        <div class="form-group">
                            <label>CFG Scale: <span class="slider-val" id="val-cfg">2.0</span></label>
                            <input type="range" class="slider" id="prof-cfg" min="1.0" max="5.0" step="0.1" value="2.0" oninput="updateSlider('cfg')">
                        </div>
                        <div class="form-group">
                            <label>Sway Coefficient: <span class="slider-val" id="val-sway">-1</span></label>
                            <input type="range" class="slider" id="prof-sway" min="-1" max="1.0" step="0.1" value="-1" oninput="updateSlider('sway')">
                        </div>
                        <div class="form-group">
                            <label>Speed: <span class="slider-val" id="val-f5speed">1.0</span></label>
                            <input type="range" class="slider" id="prof-f5speed" min="0.5" max="2.0" step="0.05" value="1.0" oninput="updateSlider('f5speed')">
                        </div>
                    </div>
                </div>
                <button onclick="createProfile()" style="margin-top: 12px;">Create Profile</button>
            </div>
            <div class="card">
                <h2>Existing Profiles</h2>
                <button class="btn-secondary btn-sm" onclick="loadProfiles()">üîÑ Refresh</button>
                <div id="profiles-list" style="margin-top: 12px;"></div>
            </div>
        </div>

        <!-- EDIT PROFILE MODAL -->
        <div id="edit-modal" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; overflow-y: auto;">
            <div style="max-width: 800px; margin: 50px auto; background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 24px;">
                <h2 style="margin-bottom: 16px;">Edit Quality Profile</h2>
                <div id="edit-msg" class="msg"></div>
                <input type="hidden" id="edit-engine">
                <input type="hidden" id="edit-id">
                <div class="form-group">
                    <label>Name *</label>
                    <input type="text" id="edit-name">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" id="edit-desc">
                </div>
                <div id="edit-params"></div>
                <div style="margin-top: 20px; display: flex; gap: 8px;">
                    <button onclick="saveProfileEdit()">üíæ Save Changes</button>
                    <button class="btn-secondary" onclick="closeEditModal()">Cancel</button>
                </div>
            </div>
        </div>

        <!-- RVC TAB -->
        <div id="tab-rvc" class="content">
            <div class="card">
                <h2>Upload RVC Model</h2>
                <div id="rvc-msg" class="msg"></div>
                <div class="grid">
                    <div class="form-group">
                        <label>Model Name *</label>
                        <input type="text" id="rvc-name" placeholder="my_voice_model">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" id="rvc-desc" placeholder="Custom voice conversion model">
                    </div>
                </div>
                <div class="grid">
                    <div class="form-group">
                        <label>PTH File * (.pth)</label>
                        <input type="file" id="rvc-pth" accept=".pth">
                        <small style="color: var(--text-dim);">Required - RVC model weights file</small>
                    </div>
                    <div class="form-group">
                        <label>Index File (.index, optional)</label>
                        <input type="file" id="rvc-index" accept=".index">
                        <small style="color: var(--text-dim);">Optional - Feature index for better quality</small>
                    </div>
                </div>
                <button onclick="uploadRVCModel()" style="margin-top: 12px;">üì§ Upload Model</button>
            </div>
            <div class="card">
                <h2>Existing RVC Models</h2>
                <button class="btn-secondary btn-sm" onclick="loadRVCModels()">üîÑ Refresh</button>
                <div id="rvc-list" style="margin-top: 12px;"></div>
            </div>
        </div>

        <!-- ADMIN TAB -->
        <div id="tab-admin" class="content">
            <div class="grid">
                <div class="card">
                    <h2>Cleanup</h2>
                    <button onclick="cleanup(false)">Basic Cleanup</button>
                    <button class="btn-danger" onclick="cleanup(true)" style="margin-left: 8px;">Deep Cleanup (FLUSH)</button>
                </div>
                <div class="card">
                    <h2>Statistics</h2>
                    <button onclick="loadStats()">Load Stats</button>
                    <pre id="stats" style="margin-top: 12px;"></pre>
                </div>
            </div>
            <div class="card">
                <h2>Health Check</h2>
                <button onclick="healthCheck()">Check Health</button>
                <pre id="health" style="margin-top: 12px;"></pre>
            </div>
        </div>
    </div>

    <script>
        const API = '';
        let pollInterval = null;

        function showTab(name) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('tab-' + name).classList.add('active');
            if (name === 'voices') loadVoices();
            if (name === 'jobs') loadJobs();
            if (name === 'profiles') loadProfiles();
            if (name === 'rvc') loadRVCModels();
        }

        function msg(id, type, text) {
            const el = document.getElementById(id);
            el.className = `msg show ${type}`;
            el.textContent = text;
            setTimeout(() => el.classList.remove('show'), 5000);
        }

        function updateSlider(name) {
            const slider = document.getElementById('prof-' + name) || 
                          document.getElementById('edit-' + name) || 
                          document.getElementById('tts-rvc-' + name);
            const valEl = document.getElementById('val-' + name);
            if (slider && valEl) {
                valEl.textContent = slider.value;
            }
        }

        function toggleRVCOptions() {
            const enabled = document.getElementById('tts-enable-rvc').checked;
            document.getElementById('rvc-options').style.display = enabled ? 'block' : 'none';
        }

        function toggleCustomRef() {
            const enabled = document.getElementById('voice-use-custom-ref').checked;
            document.getElementById('custom-ref-section').style.display = enabled ? 'block' : 'none';
        }

        function updateModeLogic() {
            const mode = document.getElementById('tts-mode').value;
            const presetGroup = document.getElementById('preset-group');
            const voiceIdGroup = document.getElementById('voice-id-group');
            
            if (mode === 'dubbing_with_clone') {
                // Cloned Voice mode: hide preset, show voice ID
                presetGroup.style.display = 'none';
                voiceIdGroup.style.display = 'block';
            } else {
                // Generic Voice mode: show preset, hide voice ID
                presetGroup.style.display = 'block';
                voiceIdGroup.style.display = 'none';
            }
        }

        function filterProfilesByEngine() {
            const selectedEngine = document.getElementById('tts-engine').value;
            const select = document.getElementById('tts-profile');
            
            if (!window.cachedProfiles) {
                return; // Profiles not loaded yet
            }
            
            const xttsProfiles = window.cachedProfiles.xtts_profiles || [];
            const f5ttsProfiles = window.cachedProfiles.f5tts_profiles || [];
            
            const filtered = selectedEngine === 'xtts' ? xttsProfiles : f5ttsProfiles;
            
            select.innerHTML = '<option value="">Default</option>' + filtered.map(p => 
                `<option value="${p.id}">${p.name}</option>`
            ).join('');
        }

        function updateProfileForm() {
            const engine = document.getElementById('prof-engine').value;
            document.getElementById('xtts-params').style.display = engine === 'xtts' ? 'block' : 'none';
            document.getElementById('f5tts-params').style.display = engine === 'f5tts' ? 'block' : 'none';
        }

        async function createTTSJob() {
            const text = document.getElementById('tts-text').value.trim();
            if (!text) {
                return msg('tts-msg', 'error', '‚ùå Text is required');
            }
            
            const mode = document.getElementById('tts-mode').value;
            const formData = new FormData();
            formData.append('text', text);
            formData.append('source_language', document.getElementById('tts-lang').value);
            formData.append('target_language', document.getElementById('tts-lang').value);
            formData.append('mode', mode);
            
            // Conditional logic: send voice_preset OR voice_id based on mode
            if (mode === 'dubbing') {
                formData.append('voice_preset', document.getElementById('tts-preset').value);
            } else if (mode === 'dubbing_with_clone') {
                const voiceId = document.getElementById('tts-voice-id').value;
                if (!voiceId) {
                    return msg('tts-msg', 'error', '‚ùå Select a cloned voice for this mode');
                }
                formData.append('voice_id', voiceId);
            }
            
            formData.append('tts_engine', document.getElementById('tts-engine').value);
            const profile = document.getElementById('tts-profile').value;
            if (profile) formData.append('quality_profile_id', profile);

            // RVC Parameters
            const enableRvc = document.getElementById('tts-enable-rvc').checked;
            if (enableRvc) {
                const rvcModel = document.getElementById('tts-rvc-model').value;
                if (!rvcModel) {
                    return msg('tts-msg', 'error', '‚ùå Select RVC model when RVC is enabled');
                }
                formData.append('enable_rvc', 'true');
                formData.append('rvc_model_id', rvcModel);
                formData.append('rvc_pitch', document.getElementById('tts-rvc-pitch').value);
                formData.append('rvc_index_rate', document.getElementById('tts-rvc-index-rate').value);
                formData.append('rvc_filter_radius', document.getElementById('tts-rvc-filter').value);
            }

            try {
                const res = await fetch('/jobs', { method: 'POST', body: formData });
                const data = await res.json();
                if (!res.ok) throw new Error(data.detail || 'Error');
                document.getElementById('tts-job-id').textContent = data.job_id;
                document.getElementById('tts-result').style.display = 'block';
                msg('tts-msg', 'success', '‚úÖ Job created: ' + data.job_id);
                pollJob(data.job_id);
            } catch (e) {
                msg('tts-msg', 'error', '‚ùå ' + e.message);
            }
        }

        async function pollJob(jobId) {
            if (pollInterval) clearInterval(pollInterval);
            pollInterval = setInterval(async () => {
                const res = await fetch('/jobs/' + jobId);
                const job = await res.json();
                document.getElementById('tts-status').textContent = `Status: ${job.status}`;
                if (job.status === 'completed') {
                    clearInterval(pollInterval);
                    const audio = document.getElementById('tts-audio');
                    audio.src = `/jobs/${jobId}/download?format=mp3`;
                    audio.style.display = 'block';
                } else if (job.status === 'failed') {
                    clearInterval(pollInterval);
                    document.getElementById('tts-status').textContent = 'Failed: ' + (job.error || 'Unknown');
                }
            }, 2000);
        }

        async function cloneVoice() {
            const file = document.getElementById('voice-file').files[0];
            if (!file) return msg('voice-msg', 'error', '‚ùå Select audio file');
            
            const name = document.getElementById('voice-name').value.trim();
            if (!name) return msg('voice-msg', 'error', '‚ùå Voice name is required');
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('name', name);
            formData.append('language', document.getElementById('voice-lang').value);
            const desc = document.getElementById('voice-desc').value;
            if (desc) formData.append('description', desc);
            
            // Enviar ref_text apenas se o usu√°rio marcou para usar override customizado
            const useCustomRef = document.getElementById('voice-use-custom-ref').checked;
            if (useCustomRef) {
                const ref = document.getElementById('voice-ref').value.trim();
                if (ref) {
                    formData.append('ref_text', ref);
                } else {
                    return msg('voice-msg', 'error', '‚ùå Provide custom reference text or uncheck the override option');
                }
            }

            try {
                const res = await fetch('/voices/clone', { method: 'POST', body: formData });
                const data = await res.json();
                if (!res.ok) throw new Error(data.detail || 'Error');
                msg('voice-msg', 'success', '‚úÖ Voice cloning started: ' + data.job_id);
                setTimeout(loadVoices, 10000);
            } catch (e) {
                msg('voice-msg', 'error', '‚ùå ' + e.message);
            }
        }

        async function loadVoices() {
            try {
                const res = await fetch('/voices');
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                const list = document.getElementById('voice-list');
                const select = document.getElementById('tts-voice-id');
                
                if (data.voices.length === 0) {
                    list.innerHTML = '<p style="color: var(--text-dim);">No cloned voices yet. Clone one above!</p>';
                    select.innerHTML = '<option value="">None</option>';
                } else {
                    list.innerHTML = data.voices.map(v => `
                        <div style="background: var(--bg); padding: 12px; border-radius: 4px; margin-bottom: 8px;">
                            <strong>${v.name}</strong> <span style="background: #333; padding: 2px 6px; border-radius: 3px; font-size: 11px;">${v.language}</span>
                            <br><small style="color: var(--text-dim);">${v.description || 'No description'}</small>
                            <br><small style="color: var(--text-dim);">ID: ${v.voice_id.substring(0, 24)}...</small>
                            <br><button class="btn-danger btn-sm" style="margin-top: 6px;" onclick="deleteVoice('${v.voice_id}')">Delete</button>
                        </div>
                    `).join('');
                    select.innerHTML = '<option value="">None</option>' + data.voices.map(v => 
                        `<option value="${v.voice_id}">${v.name}</option>`
                    ).join('');
                }
            } catch (e) {
                msg('voice-msg', 'error', 'Failed to load voices: ' + e.message);
            }
        }

        async function deleteVoice(id) {
            if (!confirm('Delete this voice? This action cannot be undone.')) return;
            try {
                const res = await fetch('/voices/' + id, { method: 'DELETE' });
                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.detail || 'Delete failed');
                }
                msg('voice-msg', 'success', '‚úÖ Voice deleted');
                loadVoices();
            } catch (e) {
                msg('voice-msg', 'error', '‚ùå ' + e.message);
            }
        }

        async function loadJobs() {
            try {
                const limit = document.getElementById('jobs-limit')?.value || '50';
                const statusFilter = document.getElementById('jobs-status-filter')?.value || '';
                
                const res = await fetch(`/jobs?limit=${limit}`);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                
                let jobs = data.jobs || [];
                
                // Aplicar filtro de status
                if (statusFilter) {
                    jobs = jobs.filter(j => j.status === statusFilter);
                }
                
                const tbody = document.getElementById('jobs-tbody');
                if (jobs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color: var(--text-dim);">No jobs found</td></tr>';
                } else {
                    tbody.innerHTML = jobs.map(j => `
                        <tr>
                            <td><code style="font-size:11px;">${j.job_id.substring(0,20)}...</code></td>
                            <td><span class="status ${j.status}">${j.status}</span></td>
                            <td>${j.tts_engine || '-'}</td>
                            <td style="font-size:11px;">${new Date(j.created_at).toLocaleString()}</td>
                            <td>
                            ${j.status === 'completed' ? `<button class="btn-sm btn-success" onclick="window.open('/jobs/${j.job_id}/download?format=mp3')">‚¨áÔ∏è</button>` : ''}
                            <button class="btn-sm btn-danger" onclick="deleteJob('${j.job_id}')">‚úï</button>
                        </td>
                    </tr>
                `).join('');
                }
            } catch (e) {
                console.error('Failed to load jobs:', e);
            }
        }

        async function deleteJob(id) {
            if (!confirm('Delete this job?')) return;
            await fetch('/jobs/' + id, { method: 'DELETE' });
            loadJobs();
        }

        async function createProfile() {
            // Valida√ß√£o client-side
            const name = document.getElementById('prof-name').value.trim();
            if (!name) {
                return msg('profile-msg', 'error', 'Profile name is required');
            }
            
            const engine = document.getElementById('prof-engine').value;
            const params = engine === 'xtts' ? {
                temperature: parseFloat(document.getElementById('prof-temp').value),
                repetition_penalty: parseFloat(document.getElementById('prof-rep').value),
                top_p: parseFloat(document.getElementById('prof-topp').value),
                top_k: parseInt(document.getElementById('prof-topk').value),
                length_penalty: parseFloat(document.getElementById('prof-len').value),
                speed: parseFloat(document.getElementById('prof-speed').value),
                enable_text_splitting: false
            } : {
                nfe_step: parseInt(document.getElementById('prof-nfe').value),
                cfg_strength: parseFloat(document.getElementById('prof-cfg').value),
                sway_sampling_coef: parseFloat(document.getElementById('prof-sway').value),
                speed: parseFloat(document.getElementById('prof-f5speed').value)
            };

            try {
                const res = await fetch('/quality-profiles', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name,
                        description: document.getElementById('prof-desc').value || '',
                        engine: engine,
                        is_default: false,
                        parameters: params
                    })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.detail || 'Error creating profile');
                msg('profile-msg', 'success', '‚úÖ Profile created: ' + data.id);
                // Limpar formul√°rio
                document.getElementById('prof-name').value = '';
                document.getElementById('prof-desc').value = '';
                // Atualizar lista
                loadProfiles();
            } catch (e) {
                msg('profile-msg', 'error', '‚ùå ' + e.message);
            }
        }

        async function loadProfiles() {
            try {
                const res = await fetch('/quality-profiles');
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                
                // Cachear para uso no filtro de engine
                window.cachedProfiles = data;
                
                const list = document.getElementById('profiles-list');
                const select = document.getElementById('tts-profile');
                
                const all = [...data.xtts_profiles, ...data.f5tts_profiles];
                
                if (all.length === 0) {
                    list.innerHTML = '<p style="color: var(--text-dim);">No profiles yet. Create one above!</p>';
                } else {
                    list.innerHTML = all.map(p => `
                        <div style="background: var(--bg); padding: 12px; border-radius: 4px; margin-bottom: 8px;">
                            <strong>${p.name}</strong> <span style="background: #333; padding: 2px 6px; border-radius: 3px; font-size: 11px;">${p.engine.toUpperCase()}</span>
                            <br><small style="color: var(--text-dim);">${p.description || 'No description'}</small>
                            <br><small style="color: var(--text-dim);">ID: ${p.id.substring(0, 16)}...</small>
                            ${!p.is_default ? `
                                <br><button class="btn-secondary btn-sm" style="margin-top: 6px; margin-right: 4px;" onclick="editProfile('${p.engine}','${p.id}')">‚úèÔ∏è Edit</button>
                                <button class="btn-danger btn-sm" style="margin-top: 6px;" onclick="deleteProfile('${p.engine}','${p.id}')">Delete</button>
                            ` : '<br><small style="color: #4a9eff;">üìå Default Profile</small>'}
                        </div>
                    `).join('');
                }

                select.innerHTML = '<option value="">Default</option>' + all.map(p => 
                    `<option value="${p.id}">${p.name} (${p.engine})</option>`
                ).join('');
                
                // Aplicar filtro inicial por engine
                filterProfilesByEngine();
            } catch (e) {
                msg('profile-msg', 'error', 'Failed to load profiles: ' + e.message);
            }
        }

        async function deleteProfile(engine, id) {
            if (!confirm('Delete this profile? This action cannot be undone.')) return;
            try {
                const res = await fetch(`/quality-profiles/${engine}/${id}`, { method: 'DELETE' });
                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.detail || 'Delete failed');
                }
                msg('profile-msg', 'success', '‚úÖ Profile deleted');
                loadProfiles();
            } catch (e) {
                msg('profile-msg', 'error', '‚ùå ' + e.message);
            }
        }

        async function editProfile(engine, id) {
            try {
                // Buscar profile atual
                const res = await fetch(`/quality-profiles/${engine}/${id}`);
                if (!res.ok) throw new Error('Profile not found');
                const profile = await res.json();
                
                // Preencher modal
                document.getElementById('edit-engine').value = engine;
                document.getElementById('edit-id').value = id;
                document.getElementById('edit-name').value = profile.name;
                document.getElementById('edit-desc').value = profile.description || '';
                
                // Criar campos de par√¢metros dinamicamente
                const paramsDiv = document.getElementById('edit-params');
                if (engine === 'xtts') {
                    paramsDiv.innerHTML = `
                        <h3 style="margin: 16px 0 8px; font-size: 14px;">XTTS Parameters</h3>
                        <div class="grid">
                            <div class="form-group">
                                <label>Temperature</label>
                                <input type="number" id="edit-temp" step="0.05" min="0.1" max="1.0" value="${profile.temperature || 0.75}">
                            </div>
                            <div class="form-group">
                                <label>Repetition Penalty</label>
                                <input type="number" id="edit-rep" step="0.1" min="1.0" max="5.0" value="${profile.repetition_penalty || 1.5}">
                            </div>
                            <div class="form-group">
                                <label>Top P</label>
                                <input type="number" id="edit-topp" step="0.05" min="0.1" max="1.0" value="${profile.top_p || 0.9}">
                            </div>
                            <div class="form-group">
                                <label>Top K</label>
                                <input type="number" id="edit-topk" step="5" min="10" max="100" value="${profile.top_k || 60}">
                            </div>
                            <div class="form-group">
                                <label>Length Penalty</label>
                                <input type="number" id="edit-len" step="0.1" min="0.5" max="2.0" value="${profile.length_penalty || 1.2}">
                            </div>
                            <div class="form-group">
                                <label>Speed</label>
                                <input type="number" id="edit-speed" step="0.05" min="0.5" max="2.0" value="${profile.speed || 1.0}">
                            </div>
                        </div>
                    `;
                } else {
                    paramsDiv.innerHTML = `
                        <h3 style="margin: 16px 0 8px; font-size: 14px;">F5-TTS Parameters</h3>
                        <div class="grid">
                            <div class="form-group">
                                <label>NFE Steps</label>
                                <input type="number" id="edit-nfe" step="8" min="8" max="128" value="${profile.nfe_step || 32}">
                            </div>
                            <div class="form-group">
                                <label>CFG Scale</label>
                                <input type="number" id="edit-cfg" step="0.1" min="1.0" max="5.0" value="${profile.cfg_scale || 2.0}">
                            </div>
                            <div class="form-group">
                                <label>Sway Coefficient</label>
                                <input type="number" id="edit-sway" step="0.1" min="-1" max="1.0" value="${profile.sway_sampling_coef || -1}">
                            </div>
                            <div class="form-group">
                                <label>Speed</label>
                                <input type="number" id="edit-f5speed" step="0.05" min="0.5" max="2.0" value="${profile.speed || 1.0}">
                            </div>
                        </div>
                    `;
                }
                
                // Mostrar modal
                document.getElementById('edit-modal').style.display = 'block';
            } catch (e) {
                msg('profile-msg', 'error', '‚ùå Failed to load profile: ' + e.message);
            }
        }

        function closeEditModal() {
            document.getElementById('edit-modal').style.display = 'none';
            document.getElementById('edit-msg').className = 'msg';
            document.getElementById('edit-msg').textContent = '';
        }

        async function saveProfileEdit() {
            const engine = document.getElementById('edit-engine').value;
            const id = document.getElementById('edit-id').value;
            const name = document.getElementById('edit-name').value.trim();
            
            if (!name) {
                return msg('edit-msg', 'error', 'Name is required');
            }
            
            const params = engine === 'xtts' ? {
                temperature: parseFloat(document.getElementById('edit-temp').value),
                repetition_penalty: parseFloat(document.getElementById('edit-rep').value),
                top_p: parseFloat(document.getElementById('edit-topp').value),
                top_k: parseInt(document.getElementById('edit-topk').value),
                length_penalty: parseFloat(document.getElementById('edit-len').value),
                speed: parseFloat(document.getElementById('edit-speed').value),
                enable_text_splitting: false
            } : {
                nfe_step: parseInt(document.getElementById('edit-nfe').value),
                cfg_strength: parseFloat(document.getElementById('edit-cfg').value),
                sway_sampling_coef: parseFloat(document.getElementById('edit-sway').value),
                speed: parseFloat(document.getElementById('edit-f5speed').value)
            };
            
            try {
                const res = await fetch(`/quality-profiles/${engine}/${id}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name,
                        description: document.getElementById('edit-desc').value || '',
                        parameters: params
                    })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.detail || 'Update failed');
                
                msg('edit-msg', 'success', '‚úÖ Profile updated!');
                setTimeout(() => {
                    closeEditModal();
                    loadProfiles();
                    msg('profile-msg', 'success', '‚úÖ Profile updated successfully');
                }, 1000);
            } catch (e) {
                msg('edit-msg', 'error', '‚ùå ' + e.message);
            }
        }

        async function uploadRVCModel() {
            const name = document.getElementById('rvc-name').value.trim();
            if (!name) {
                return msg('rvc-msg', 'error', 'Model name is required');
            }
            
            const pthFile = document.getElementById('rvc-pth').files[0];
            if (!pthFile) {
                return msg('rvc-msg', 'error', 'PTH file is required');
            }
            
            const formData = new FormData();
            formData.append('name', name);
            const desc = document.getElementById('rvc-desc').value;
            if (desc) formData.append('description', desc);
            formData.append('pth_file', pthFile);
            
            const indexFile = document.getElementById('rvc-index').files[0];
            if (indexFile) formData.append('index_file', indexFile);
            
            try {
                const res = await fetch('/rvc-models', { 
                    method: 'POST', 
                    body: formData 
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.detail || 'Upload failed');
                
                msg('rvc-msg', 'success', '‚úÖ Model uploaded: ' + data.model_id);
                // Limpar formul√°rio
                document.getElementById('rvc-name').value = '';
                document.getElementById('rvc-desc').value = '';
                document.getElementById('rvc-pth').value = '';
                document.getElementById('rvc-index').value = '';
                // Atualizar lista
                loadRVCModels();
            } catch (e) {
                msg('rvc-msg', 'error', '‚ùå ' + e.message);
            }
        }

        async function loadRVCModels() {
            try {
                const res = await fetch('/rvc-models');
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                
                // Cachear para uso no select do TTS
                window.cachedRVCModels = data.models || [];
                
                const list = document.getElementById('rvc-list');
                const ttsSelect = document.getElementById('tts-rvc-model');
                
                if (!data.models || data.models.length === 0) {
                    list.innerHTML = '<p style="color: var(--text-dim);">No RVC models yet. Upload one above!</p>';
                    if (ttsSelect) {
                        ttsSelect.innerHTML = '<option value="">No models available</option>';
                    }
                } else {
                    list.innerHTML = data.models.map(m => `
                        <div style="background: var(--bg); padding: 12px; border-radius: 4px; margin-bottom: 8px;">
                            <strong>${m.name}</strong>
                            <br><small style="color: var(--text-dim);">${m.description || 'No description'}</small>
                            <br><small style="color: var(--text-dim);">ID: ${m.model_id.substring(0, 24)}...</small>
                            <br><button class="btn-danger btn-sm" style="margin-top: 6px;" onclick="deleteRVCModel('${m.model_id}')">Delete</button>
                        </div>
                    `).join('');
                    
                    // Popular select no TTS tab (se existir)
                    if (ttsSelect) {
                        ttsSelect.innerHTML = '<option value="">Select model...</option>' + 
                            data.models.map(m => 
                                `<option value="${m.model_id}">${m.name}</option>`
                            ).join('');
                    }
                }
            } catch (e) {
                msg('rvc-msg', 'error', 'Failed to load RVC models: ' + e.message);
            }
        }

        async function deleteRVCModel(id) {
            if (!confirm('Delete this RVC model? This action cannot be undone.')) return;
            try {
                const res = await fetch('/rvc-models/' + id, { method: 'DELETE' });
                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.detail || 'Delete failed');
                }
                msg('rvc-msg', 'success', '‚úÖ Model deleted');
                loadRVCModels();
            } catch (e) {
                msg('rvc-msg', 'error', '‚ùå ' + e.message);
            }
        }

        async function cleanup(deep) {
            if (deep && !confirm('DEEP CLEANUP will flush Redis! Continue?')) return;
            const res = await fetch('/admin/cleanup', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ deep: deep })
            });
            const data = await res.json();
            alert(data.message);
        }

        async function loadStats() {
            const res = await fetch('/admin/stats');
            const data = await res.json();
            document.getElementById('stats').textContent = JSON.stringify(data, null, 2);
        }

        async function healthCheck() {
            const res = await fetch('/health');
            const data = await res.json();
            document.getElementById('health').textContent = JSON.stringify(data, null, 2);
        }

        async function checkOnline() {
            try {
                const res = await fetch('/');
                const data = await res.json();
                document.getElementById('status').textContent = '‚óè Online - v' + data.version;
            } catch {
                document.getElementById('status').textContent = '‚óè Offline';
            }
        }

        checkOnline();
        setInterval(checkOnline, 30000);
    </script>
</body>
</html>
