# ============================================================================
# Makefile - YouTube-Search Service
# ============================================================================
# Comandos padronizados para desenvolvimento, testes e deploy
# 
# Uso: make <target>
# Lista de comandos: make help
# ============================================================================

.PHONY: help
.DEFAULT_GOAL := help

# ============================================================================
# VARI√ÅVEIS
# ============================================================================

DOCKER_COMPOSE := docker compose
SERVICE_NAME := youtube-search
PYTHON := python3
VENV := .venv
VENV_BIN := $(VENV)/bin
VENV_PYTHON := $(VENV_BIN)/python
VENV_PYTEST := $(VENV_BIN)/pytest
LOG_DIR := ./logs
API_BASE_URL := http://localhost:8001
PORT ?= 8001

# ============================================================================
# HELP
# ============================================================================

help: ## Mostrar esta mensagem de ajuda
	@echo ""
	@echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
	@echo "‚ïë       YouTube-Search Service - Comandos Dispon√≠veis            ‚ïë"
	@echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | \
		awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-25s\033[0m %s\n", $$1, $$2}'
	@echo ""
	@echo "üìö Categorias:"
	@echo "  ‚Ä¢ Desenvolvimento: install, venv, dev, shell"
	@echo "  ‚Ä¢ Testes: test, test-unit, test-integration, test-endpoints"
	@echo "  ‚Ä¢ Docker: build, up, down, restart, logs, ps"
	@echo "  ‚Ä¢ API: health, search, shorts, status"
	@echo "  ‚Ä¢ Manuten√ß√£o: clean, clean-all, validate"
	@echo ""

# ============================================================================
# DESENVOLVIMENTO
# ============================================================================

venv: ## Criar virtual environment (.venv)
	@echo "üêç Criando virtual environment..."
	@if [ ! -d "$(VENV)" ]; then \
		$(PYTHON) -m venv $(VENV); \
		echo "‚úÖ Virtual environment criado: $(VENV)"; \
		echo "üí° Ativar: source $(VENV)/bin/activate"; \
	else \
		echo "‚úÖ Virtual environment j√° existe: $(VENV)"; \
	fi

install: venv ## Instalar depend√™ncias Python no venv
	@echo "üì¶ Instalando depend√™ncias no venv..."
	$(VENV_PYTHON) -m pip install --upgrade pip
	$(VENV_PYTHON) -m pip install -r requirements.txt
	@echo "‚úÖ Depend√™ncias instaladas!"

dev: ## Rodar servi√ßo em modo desenvolvimento (local, sem Docker)
	@echo "üöÄ Iniciando $(SERVICE_NAME) em modo dev..."
	@echo "   Port: $(PORT)"
	PORT=$(PORT) $(VENV_PYTHON) run.py

shell: ## Abrir shell Python com ambiente configurado
	@echo "üêç Abrindo Python shell..."
	$(VENV_PYTHON)

# ============================================================================
# TESTES
# ============================================================================

test: ## Rodar todos os testes
	@echo "üß™ Rodando todos os testes..."
	$(VENV_PYTEST) tests/ -v

test-unit: ## Rodar apenas testes unit√°rios
	@echo "üß™ Rodando testes unit√°rios..."
	$(VENV_PYTEST) tests/unit/ -v

test-integration: ## Rodar testes de integra√ß√£o
	@echo "üß™ Rodando testes de integra√ß√£o..."
	$(VENV_PYTEST) tests/integration/ -v

test-endpoints: ## Testar todos os endpoints via shell script
	@echo "üß™ Testando endpoints..."
	@bash test_all_endpoints.sh

test-shorts: ## Testar funcionalidade de shorts
	@echo "üß™ Testando shorts..."
	@bash test_shorts_feature.sh

test-coverage: ## Rodar testes com coverage
	@echo "üìä Rodando testes com coverage..."
	$(VENV_PYTEST) tests/ --cov=app --cov-report=html --cov-report=term

# ============================================================================
# DOCKER
# ============================================================================

build: ## Build das imagens Docker
	@echo "üî® Building $(SERVICE_NAME)..."
	$(DOCKER_COMPOSE) build --no-cache

up: ## Subir containers
	@echo "üöÄ Iniciando $(SERVICE_NAME)..."
	$(DOCKER_COMPOSE) up -d
	@echo "‚úÖ $(SERVICE_NAME) iniciado!"
	@echo "üìä Verifique: make logs"

down: ## Derrubar containers
	@echo "üõë Parando $(SERVICE_NAME)..."
	$(DOCKER_COMPOSE) down
	@echo "‚úÖ $(SERVICE_NAME) parado!"

restart: down up ## Reiniciar containers

logs: ## Ver logs do servi√ßo
	@$(DOCKER_COMPOSE) logs -f

logs-api: ## Ver logs apenas do API
	@docker logs -f $(SERVICE_NAME)-api

logs-celery: ## Ver logs apenas do Celery worker
	@docker logs -f $(SERVICE_NAME)-celery-worker

logs-beat: ## Ver logs do Celery beat
	@docker logs -f $(SERVICE_NAME)-celery-beat

ps: ## Listar containers
	@$(DOCKER_COMPOSE) ps

# ============================================================================
# API
# ============================================================================

health: ## Verificar health do servi√ßo
	@echo "üè• Verificando health..."
	@curl -s $(API_BASE_URL)/health | python3 -m json.tool || echo "‚ùå Servi√ßo n√£o dispon√≠vel"

search: ## Testar busca (use QUERY="termo")
	@echo "üîç Buscando: $(QUERY)"
	@curl -s "$(API_BASE_URL)/search?q=$(QUERY)&limit=5" | python3 -m json.tool

shorts: ## Testar busca de shorts
	@echo "üì± Buscando shorts..."
	@curl -s "$(API_BASE_URL)/shorts?limit=5" | python3 -m json.tool

status: ## Ver status completo
	@echo "üìä Status do $(SERVICE_NAME):"
	@echo ""
	@echo "Containers:"
	@$(DOCKER_COMPOSE) ps
	@echo ""
	@echo "Health:"
	@curl -s $(API_BASE_URL)/health | python3 -m json.tool 2>/dev/null || echo "‚ùå API offline"

# ============================================================================
# MANUTEN√á√ÉO
# ============================================================================

clean: ## Limpar arquivos tempor√°rios
	@echo "üßπ Limpando arquivos tempor√°rios..."
	rm -rf __pycache__ app/__pycache__
	rm -rf .pytest_cache
	rm -rf .coverage htmlcov
	@echo "‚úÖ Limpeza conclu√≠da!"

clean-all: clean ## Limpar tudo (incluindo logs)
	@echo "üßπ Limpeza TOTAL..."
	rm -rf $(LOG_DIR)/*.log $(LOG_DIR)/*.json
	@echo "‚úÖ Limpeza total conclu√≠da!"

clean-docker: ## Limpar imagens Docker
	@echo "üßπ Limpando imagens Docker..."
	docker rmi -f $(SERVICE_NAME)-youtube-search-service $(SERVICE_NAME)-celery-worker $(SERVICE_NAME)-celery-beat 2>/dev/null || true
	@echo "‚úÖ Imagens removidas!"

validate: ## Validar configura√ß√£o
	@echo "‚úÖ Validando $(SERVICE_NAME)..."
	@echo "Checando docker-compose.yml..."
	@$(DOCKER_COMPOSE) config > /dev/null && echo "‚úÖ docker-compose.yml v√°lido"
	@echo "Checando .env..."
	@test -f .env && echo "‚úÖ .env existe" || echo "‚ö†Ô∏è  .env n√£o encontrado"
	@echo "Checando Dockerfile..."
	@test -f Dockerfile && echo "‚úÖ Dockerfile existe" || echo "‚ùå Dockerfile n√£o encontrado"
	@echo "Checando requirements.txt..."
	@test -f requirements.txt && echo "‚úÖ requirements.txt existe" || echo "‚ùå requirements.txt n√£o encontrado"

# ============================================================================
# UTILIT√ÅRIOS
# ============================================================================

shell-api: ## Shell no container da API
	@docker exec -it $(SERVICE_NAME)-api /bin/bash

shell-celery: ## Shell no container do Celery
	@docker exec -it $(SERVICE_NAME)-celery-worker /bin/bash

fix-permissions: ## Corrigir permiss√µes dos diret√≥rios
	@echo "üîß Corrigindo permiss√µes..."
	@mkdir -p $(LOG_DIR)
	@sudo chown -R 1000:1000 $(LOG_DIR)
	@chmod -R 777 $(LOG_DIR)
	@echo "‚úÖ Permiss√µes corrigidas para uid 1000!"
