# =============================================================================
# MAKE-VIDEO SERVICE - ENVIRONMENT CONFIGURATION
# =============================================================================
# Template de variáveis de ambiente
#
# INSTRUÇÕES:
# 1. Copie este arquivo: cp .env.example .env
# 2. Edite .env com suas configurações
# 3. NUNCA commite o arquivo .env (contém credenciais)
#
# Última atualização: 04/02/2026
# =============================================================================

# Timezone
TZ=America/Sao_Paulo

# -----------------------------------------------------------------------------
# SERVIDOR E DEBUG
# -----------------------------------------------------------------------------

# Divisor Redis (identifica microserviço)
DIVISOR=5

# Porta do servidor FastAPI
PORT=800${DIVISOR}

# Modo debug (ativa logs verbose)
# Valores: True, False
DEBUG=False

# Nível de log
# Valores: DEBUG, INFO, WARNING, ERROR, CRITICAL
LOG_LEVEL=INFO

# Formato de log
# Valores: json, text
LOG_FORMAT=json

# Diretório de logs
LOG_DIR=/app/data/logs/app

# -----------------------------------------------------------------------------
# REDIS (Message Broker para Celery)
# -----------------------------------------------------------------------------

# URL de conexão Redis
# IMPORTANTE: Redis é usado APENAS para Celery (message broker + result backend)
# A blacklist de vídeos usa SQLite (não Redis)
# Formato: redis://[username:password@]host:port/db
# Exemplos:
#   - Local: redis://localhost:6379/0
#   - Docker: redis://redis:6379/0
#   - Cloud: redis://:password@redis.example.com:6379/0
REDIS_URL=redis://192.168.1.110:6379/0

# TTL do cache de jobs no Redis (horas)
# Jobs completados expiram após este período
CACHE_TTL_HOURS=24

# Tamanho máximo do cache em disco (GB)
# Previne overflow de disco
MAX_CACHE_SIZE_GB=50

# -----------------------------------------------------------------------------
# MICROSERVIÇOS DEPENDENTES
# -----------------------------------------------------------------------------

# YouTube Search Service (busca de shorts)
YOUTUBE_SEARCH_URL=https://ytsearch.loadstask.com
# Video Downloader Service (download de shorts)
VIDEO_DOWNLOADER_URL=https://ytdownloader.loadstask.com
# Audio Transcriber Service (transcrição de áudio)
AUDIO_TRANSCRIBER_URL=https://yttranscriber.loadstask.com

# -----------------------------------------------------------------------------
# DIRETÓRIOS DE ARMAZENAMENTO
# -----------------------------------------------------------------------------

# Diretório para áudios enviados pelos usuários
# Organizados por job_id
AUDIO_UPLOAD_DIR=/app/data/raw/audio

# Cache de shorts baixados do YouTube
# Reutilizados entre jobs para economizar bandwidth
SHORTS_CACHE_DIR=/app/data/raw/shorts

# Arquivos temporários de processamento
# Limpos automaticamente após CLEANUP_TEMP_AFTER_HOURS
TEMP_DIR=/app/data/transform/temp

# Vídeos finalizados (output)
# Disponíveis para download via /download/{job_id}
OUTPUT_DIR=/app/data/approved/output

# -----------------------------------------------------------------------------
# PROCESSAMENTO DE VÍDEO
# -----------------------------------------------------------------------------

# Aspect ratio padrão para vídeos
# Valores: 9:16 (vertical), 16:9 (horizontal), 1:1 (quadrado), 4:5 (Instagram)
DEFAULT_ASPECT_RATIO=9:16

# Posição do crop ao ajustar aspect ratio
# Valores: center, top, bottom
DEFAULT_CROP_POSITION=center

# Qualidade de encoding FFmpeg
# Valores: fast (menor qualidade, mais rápido), medium, high (maior qualidade, mais lento)
DEFAULT_VIDEO_QUALITY=fast

# Padding ao final do vídeo (milissegundos)
# Vídeo final = duração do áudio + padding
# Padrão: 100ms
# Valores recomendados: 100-1000ms
VIDEO_TRIM_PADDING_MS=100

# -----------------------------------------------------------------------------
# COMPATIBILIZAÇÃO DE VÍDEOS (Sistema de Normalização - Sprint-09)
# -----------------------------------------------------------------------------

# Resolução alvo para normalização (altura em pixels)
# Padrão: 720 (HD)
# Outros valores comuns: 480 (SD), 1080 (Full HD)
TARGET_VIDEO_HEIGHT=720

# Largura alvo para normalização (pixels)
# Padrão: 1280 (HD 16:9)
# Fórmula: width = height * aspect_ratio
TARGET_VIDEO_WIDTH=1280

# FPS (frames per second) alvo
# Padrão: 30.0
# Outros valores comuns: 24.0 (cinema), 25.0 (PAL), 60.0 (high motion)
TARGET_VIDEO_FPS=30.0

# Codec alvo para normalização
# Padrão: h264 (mais compatível)
# Outros: h265/hevc (melhor compressão), vp9 (WebM)
TARGET_VIDEO_CODEC=h264

# -----------------------------------------------------------------------------
# BLACKLIST DE VÍDEOS (SQLite - Permanente)
# -----------------------------------------------------------------------------

# Caminho do banco SQLite de blacklist
# Armazena PERMANENTEMENTE vídeos com legendas embutidas detectadas
# Entradas não expiram (blacklist permanente)
SQLITE_DB_PATH=/app/data/raw/shorts/blacklist.db

# -----------------------------------------------------------------------------
# LEGENDAS (Subtitles)
# -----------------------------------------------------------------------------

# Tamanho da fonte de legendas (pixels)
SUBTITLE_FONT_SIZE=22

# Nome da fonte (deve estar instalada no sistema)
# Exemplos: Arial Black, Helvetica, Impact, Roboto Bold
SUBTITLE_FONT_NAME=Arial Black

# Cor do texto da legenda (formato ASS hexadecimal)
# Formato: &HAABBGGRR& (Alpha, Blue, Green, Red)
# Exemplos:
#   - Amarelo: &H00FFFF&
#   - Branco: &H00FFFFFF&
#   - Vermelho: &H000000FF&
SUBTITLE_COLOR=&H00FFFF&

# Cor do outline/contorno (formato ASS)
# Geralmente preto para contraste
SUBTITLE_OUTLINE_COLOR=&H000000&

# Espessura do outline (pixels)
# Valores: 0 (sem outline), 1-5 (fino a grosso)
SUBTITLE_OUTLINE=2

# Alinhamento da legenda (formato ASS)
# Valores: 2 (center-bottom), 10 (center-bottom com margem), 8 (center-middle)
SUBTITLE_ALIGNMENT=10

# Margem vertical inferior (pixels)
# Distância da legenda até a borda inferior
SUBTITLE_MARGIN_V=280

# Palavras por legenda (word-by-word mode)
# Valores: 1 (uma palavra), 2 (duas palavras), 3 (três palavras)
WORDS_PER_CAPTION=2

# -----------------------------------------------------------------------------
# TIMEOUTS E RETRIES
# -----------------------------------------------------------------------------

# Timeout geral para chamadas de API (segundos)
API_TIMEOUT=120

# Intervalo entre polls de status de download (segundos)
# Usado ao aguardar conclusão de download de shorts
DOWNLOAD_POLL_INTERVAL=3

# Máximo de polls para download (total: INTERVAL * MAX_POLLS)
# Exemplo: 3s * 40 = 120s timeout total
DOWNLOAD_MAX_POLLS=40

# Intervalo entre polls de status de transcrição (segundos)
TRANSCRIBE_POLL_INTERVAL=5

# Máximo de polls para transcrição (total: 5s * 240 = 1200s = 20 minutos)
TRANSCRIBE_MAX_POLLS=240

# Rodadas máximas de busca e validação de shorts
# Em cada rodada, busca múltiplos do max_shorts (R1=10, R2=20, R3=30, ..., R10=100)
# Continua buscando até ter duração suficiente ou atingir max rounds
# Valores: 1-20 (recomendado: 10)
MAX_FETCH_ROUNDS=10

# -----------------------------------------------------------------------------
# CLEANUP AUTOMÁTICO
# -----------------------------------------------------------------------------

# Limpar arquivos temporários após X horas
# Arquivos em TEMP_DIR mais antigos que este valor são deletados
CLEANUP_TEMP_AFTER_HOURS=1

# Limpar vídeos de output após X horas
# Vídeos finalizados são mantidos por este período antes de serem deletados
CLEANUP_OUTPUT_AFTER_HOURS=24

# Limpar cache de shorts após X dias
# Shorts baixados são mantidos em cache por este período
CLEANUP_SHORTS_CACHE_AFTER_DAYS=30

# =============================================================================
# VARIÁVEIS OPCIONAIS (Avançado)
# =============================================================================

# -----------------------------------------------------------------------------
# OCR (Optical Character Recognition)
# -----------------------------------------------------------------------------

# Usar GPU para EasyOCR (requer CUDA instalado)
# Valores: true, false
# Padrão: false (CPU only - mais compatível)
# Se true e GPU não disponível, faz fallback automático para CPU
OCR_USE_GPU=false

# Threshold de confidence para detecção de legendas embutidas
# Valores: 0.0 (detecta tudo) a 1.0 (muito restritivo)
# Padrão: 0.50 (equilibrado + densidade de detecção)
OCR_CONFIDENCE_THRESHOLD=0.50

# Frames analisados POR SEGUNDO (nova estratégia)
# Mais fps = mais preciso, mas mais lento
# Padrão: 3 fps
# Exemplo: OCR_FRAMES_PER_SECOND=3 em vídeo de 60s = 180 frames analisados
OCR_FRAMES_PER_SECOND=3

# Limite máximo de frames para evitar OOM
# Padrão: 240 frames (equivalente a 40s @ 6fps ou 60s @ 4fps)
# Valores recomendados: 180-300 frames
OCR_MAX_FRAMES=240

# -----------------------------------------------------------------------------
# TRSD (Temporal Region Subtitle Detector) - Sprint 01
# -----------------------------------------------------------------------------

# Habilitar TRSD (detector inteligente de legendas baseado em análise temporal)
# Valores: true, false
# Padrão: false (usar detector legado)
TRSD_ENABLED=false

# Largura de downscale para OCR (otimização de performance)
# Frames são redimensionados para esta largura antes do OCR
# Padrão: 640 pixels
TRSD_DOWNSCALE_WIDTH=640

# Comprimento mínimo de texto para considerar (caracteres)
# Filtra ruídos e detecções espúrias
# Padrão: 2 caracteres
TRSD_MIN_TEXT_LENGTH=2

# Confiança mínima do OCR (0.0 a 1.0)
# Palavras com confiança menor são descartadas
# Padrão: 0.50
TRSD_MIN_CONFIDENCE=0.50

# Razão mínima de caracteres alfabéticos (0.0 a 1.0)
# Filtra detecções de números/símbolos puros
# Padrão: 0.60 (60% de letras)
TRSD_MIN_ALPHA_RATIO=0.60

# Tolerância vertical para agrupar palavras em linhas (pixels)
# Palavras com Y próximo são agrupadas na mesma linha
# Padrão: 10 pixels
TRSD_LINE_Y_TOLERANCE=10

# Gap horizontal máximo entre palavras da mesma linha (pixels)
# Se gap for maior, considerar nova linha
# Padrão: 50 pixels
TRSD_LINE_X_GAP=50

# TRSD Tracking Settings - Sprint 02
# Threshold de IoU (Intersection over Union) para associar detecções entre frames
# Valores: 0.0 a 1.0 (0.3 = 30% de overlap mínimo)
# Padrão: 0.30
TRSD_TRACK_IOU_THRESHOLD=0.30

# Distância máxima (pixels) entre centros de bboxes para considerar mesmo track
# Padrão: 50 pixels
TRSD_TRACK_MAX_DISTANCE=50

# TRSD Classification Settings - Sprint 03
# ----------
# Política: Ignorar texto estático (watermarks, UI, screencasts)
# Se true: aprova vídeos com apenas texto estático
# Se false: bloqueia qualquer texto detectado
# Padrão: true (conforme especificação do usuário)
TRSD_IGNORE_STATIC_TEXT=true

# Presence ratio mínimo para considerar texto estático
# Texto estático aparece em >= X% dos frames
# Valores: 0.0 a 1.0
# Padrão: 0.85 (85% dos frames)
TRSD_STATIC_MIN_PRESENCE=0.85

# Change rate máximo para considerar texto estático
# Texto estático tem taxa de mudança <= X
# Valores: 0.0 a 1.0
# Padrão: 0.10 (10% de mudança)
TRSD_STATIC_MAX_CHANGE=0.10

# Change rate mínimo para considerar legenda dinâmica
# Legendas mudam texto com frequência >= X
# Valores: 0.0 a 1.0
# Padrão: 0.25 (25% de mudança entre detecções)
TRSD_SUBTITLE_MIN_CHANGE_RATE=0.25

# Número mínimo de detecções para considerar screencast
# Screencasts têm muitas detecções de texto (usuário usando app)
# Padrão: 10 detecções
TRSD_SCREENCAST_MIN_DETECTIONS=10

# TRSD Telemetry Settings - Sprint 07
# ----------
# Salvar eventos de detecção em JSON (para análise post-mortem)
# Valores: true, false
# Padrão: false (desabilitado em produção)
TRSD_SAVE_DETECTION_EVENTS=false

# Salvar artifacts de debug (frames com bboxes, tracks JSON)
# Valores: true, false
# Padrão: false (habilitar apenas em desenvolvimento)
TRSD_SAVE_DEBUG_ARTIFACTS=false

# -----------------------------------------------------------------------------
# VAD (Voice Activity Detection)
# -----------------------------------------------------------------------------

# Threshold de VAD para detecção de fala
# Valores: 0.0 (detecta tudo como fala) a 1.0 (muito restritivo)
# Padrão: 0.5
VAD_THRESHOLD=0.5

# Modelo VAD a usar
# Valores: webrtc (rápido), silero (preciso)
# Padrão: webrtc
VAD_MODEL=webrtc

# -----------------------------------------------------------------------------
# CELERY (Task Queue)
# -----------------------------------------------------------------------------

# Concorrência de workers Celery
# Número de processos paralelos por worker
# Padrão: 4 (ajustar baseado em CPUs disponíveis)
CELERY_WORKER_CONCURRENCY=4

# Prefetch multiplier
# Quantas tarefas cada worker busca antecipadamente
# Padrão: 1 (uma tarefa por vez)
CELERY_WORKER_PREFETCH_MULTIPLIER=1

# Task timeout (segundos)
# Tempo máximo para uma tarefa completar
# Padrão: 3600 (1 hora)
CELERY_TASK_TIME_LIMIT=3600

# Threshold de detecção de jobs órfãos (minutos)
# Jobs em "processing" sem atualização por este tempo são considerados órfãos
# Sistema de auto-recovery tenta retomar jobs órfãos automaticamente
# Padrão: 5 (5 minutos)
# Sprint-01: Auto-recovery executa a cada 2 minutos
ORPHAN_DETECTION_THRESHOLD_MINUTES=5

# -----------------------------------------------------------------------------
# FFMPEG
# -----------------------------------------------------------------------------

# Codec de vídeo
# Padrão: libx264
FFMPEG_VIDEO_CODEC=libx264

# Codec de áudio
# Padrão: aac
FFMPEG_AUDIO_CODEC=aac

# Preset de encoding
# Valores: ultrafast, superfast, veryfast, faster, fast, medium, slow, slower, veryslow
# Padrão: fast
FFMPEG_PRESET=fast

# CRF (Constant Rate Factor)
# Qualidade de vídeo: 0 (lossless) a 51 (péssima)
# Padrão: 23 (boa qualidade)
FFMPEG_CRF=23

# =============================================================================
# NOTAS IMPORTANTES
# =============================================================================
#
# 1. Segurança:
#    - NUNCA commite o arquivo .env para Git
#    - Use secrets managers em produção (AWS Secrets Manager, HashiCorp Vault)
#    - Rote credenciais regularmente
#
# 2. Docker:
#    - Use docker-compose.yml para passar variáveis de ambiente
#    - Ou use arquivo .env no diretório do docker-compose
#
# 3. Desenvolvimento vs Produção:
#    - Use .env.development e .env.production
#    - Altere DEBUG=True apenas em desenvolvimento
#    - Use URLs absolutas (http://host:port) em produção
#
# 4. Performance:
#    - Ajuste CELERY_WORKER_CONCURRENCY baseado em recursos disponíveis
#    - Aumente MAX_CACHE_SIZE_GB se tiver espaço em disco
#    - Use DEFAULT_VIDEO_QUALITY=fast para menor latência
#
# 5. Monitoramento:
#    - Habilite LOG_FORMAT=json para parsing automático
#    - Use LOG_LEVEL=DEBUG para troubleshooting
#    - Monitore métricas em /metrics (Prometheus)
#
# =============================================================================
