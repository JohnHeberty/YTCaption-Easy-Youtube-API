#!/bin/bash
# Teste de Endpoints via curl (requer container rodando)

BASE_URL="http://localhost:8004"

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐ TESTE DE ENDPOINTS API (curl)"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

# Verificar se serviรงo estรก rodando
if ! curl -s -f "$BASE_URL/health" > /dev/null 2>&1; then
    echo "โ Serviรงo nรฃo estรก respondendo em $BASE_URL"
    echo ""
    echo "Para iniciar o serviรงo:"
    echo "  cd /root/YTCaption-Easy-Youtube-API/services/make-video"
    echo "  docker compose up -d"
    echo ""
    exit 1
fi

echo "โ Serviรงo respondendo em $BASE_URL"
echo ""

# ============================================================================
# 1. GET /
# ============================================================================
echo "1๏ธโฃ  GET / (Documentaรงรฃo)"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$URL/")
echo "Status: $HTTP_CODE"
echo ""

# ============================================================================
# 2. GET /health
# ============================================================================
echo "2๏ธโฃ  GET /health"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
curl -s "$BASE_URL/health" | python3 -m json.tool 2>/dev/null | head -40
echo ""
echo ""

# ============================================================================
# 3. GET /docs
# ============================================================================
echo "3๏ธโฃ  GET /docs (Swagger UI)"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$BASE_URL/docs")
echo "Status: $HTTP_CODE"
if [ "$HTTP_CODE" = "200" ]; then
    echo "โ Swagger disponรญvel em: $BASE_URL/docs"
fi
echo ""
echo ""

# ============================================================================
# 4. POST /download (pequeno teste com 3 vรญdeos)
# ============================================================================
echo "4๏ธโฃ  POST /download (Pipeline completo - 3 vรญdeos)"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โณ Executando pipeline..."
echo ""

RESPONSE=$(curl -s -X POST "$BASE_URL/download" \
    -F "query=Videos Satisfatorios" \
    -F "max_shorts=3")

echo "$RESPONSE" | python3 -m json.tool 2>/dev/null || echo "$RESPONSE"

JOB_ID=$(echo "$RESPONSE" | python3 -c "import sys, json; print(json.load(sys.stdin).get('job_id', ''))" 2>/dev/null)

if [ -n "$JOB_ID" ]; then
    echo ""
    echo "โ Job criado: $JOB_ID"
    echo "๐ Para monitorar: curl $BASE_URL/jobs/$JOB_ID"
fi

echo ""
echo ""

# ============================================================================
# 5. GET /jobs/{job_id} (se houver job_id)
# ============================================================================
if [ -n "$JOB_ID" ]; then
    echo "5๏ธโฃ  GET /jobs/$JOB_ID (Monitorar progresso)"
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    echo "โณ Aguardando 10 segundos..."
    sleep 10
    
    curl -s "$BASE_URL/jobs/$JOB_ID" | python3 -m json.tool 2>/dev/null | head -50
    echo ""
    echo ""
fi

# ============================================================================
# SUMรRIO
# ============================================================================
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐ ENDPOINTS TESTADOS"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""
echo "โ GET  /              - Documentaรงรฃo"
echo "โ GET  /health        - Health check"
echo "โ GET  /docs          - Swagger UI"
echo "โ POST /download      - Pipeline completo"
if [ -n "$JOB_ID" ]; then
    echo "โ GET  /jobs/{id}     - Status do job"
fi
echo ""
echo "๐ Documentaรงรฃo completa: $BASE_URL/docs"
echo "๐ Guia de integraรงรฃo: INTEGRATION_GUIDE.md"
echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
