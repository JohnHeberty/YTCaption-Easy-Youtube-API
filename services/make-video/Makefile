# ============================================================================
# Makefile - Make-Video Service
# ============================================================================
# Comandos padronizados para desenvolvimento, testes, calibraÃ§Ã£o e deploy
# 
# Uso: make <target>
# Lista de comandos: make help
# ============================================================================

.PHONY: help
.DEFAULT_GOAL := help

# ============================================================================
# VARIÃVEIS
# ============================================================================

DOCKER_COMPOSE := docker compose
DOCKER_SERVICE := make-video
PYTHON := python3
DATA_DIR := ./data
RAW_DIR := $(DATA_DIR)/raw
TRANSFORM_DIR := $(DATA_DIR)/transform
VALIDATE_DIR := $(DATA_DIR)/validate
APPROVED_DIR := $(DATA_DIR)/approved
CALIBRATION_DIR := $(DATA_DIR)/calibration
LOG_DIR := /tmp
API_BASE_URL := http://localhost:8004
API_QUERY ?= Videos Satisfatorios
API_MAX_SHORTS ?= 20
API_LIMIT ?= 50
API_STATUS ?=
DAYS ?= 30
DEEP ?= false
PURGE_CELERY_QUEUE ?= false
MAX_AGE_MINUTES ?= 30
MARK_AS_FAILED ?= true

# ConfiguraÃ§Ãµes de calibraÃ§Ã£o
OPTUNA_TRIALS := 100
OPTUNA_TIMEOUT := 7200
ORPHAN_THRESHOLD := 5

# ============================================================================
# HELP
# ============================================================================

help: ## Mostrar esta mensagem de ajuda
	@echo ""
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘         Make-Video Service - Comandos DisponÃ­veis              â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | \
		awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-25s\033[0m %s\n", $$1, $$2}'
	@echo ""
	@echo "ğŸ“š Categorias:"
	@echo "  â€¢ Desenvolvimento: install, dev, logs, shell"
	@echo "  â€¢ Testes: test, test-quick, test-imports"
	@echo "  â€¢ API Controle: api-health, api-download, api-jobs, api-admin-stats"
	@echo "  â€¢ CalibraÃ§Ã£o: calibrate-start, calibrate-status, calibrate-watch, calibrate-logs"
	@echo "  â€¢ Deployment: build, up, down, restart"
	@echo "  â€¢ ManutenÃ§Ã£o: clean, clean-all, validate"
	@echo ""
	@echo "ğŸ¯ Fluxo de CalibraÃ§Ã£o:"
	@echo "  1. make calibrate-start     â†’ Iniciar em background"
	@echo "  2. make calibrate-watch     â†’ Acompanhar em tempo real"
	@echo "  3. make calibrate-status    â†’ Ver status atual"
	@echo "  4. make calibrate-apply     â†’ Aplicar melhor threshold"
	@echo ""

# ============================================================================
# DESENVOLVIMENTO
# ============================================================================

install: ## Instalar dependÃªncias Python localmente
	@echo "ğŸ“¦ Instalando dependÃªncias..."
	$(PYTHON) -m pip install --upgrade pip
	$(PYTHON) -m pip install -r requirements.txt
	@echo "âœ… DependÃªncias instaladas"

dev: ## Iniciar serviÃ§o em modo desenvolvimento
	@echo "ğŸš€ Iniciando em modo desenvolvimento..."
	$(DOCKER_COMPOSE) up --build

logs: ## Ver logs do serviÃ§o em tempo real
	$(DOCKER_COMPOSE) logs -f $(DOCKER_SERVICE)

shell: ## Abrir shell interativo no container
	$(DOCKER_COMPOSE) run --rm $(DOCKER_SERVICE) /bin/bash

# ============================================================================
# TESTES
# ============================================================================

test: ## Executar todos os testes
	@echo "ğŸ§ª Executando testes completos..."
	$(PYTHON) -m pytest tests/ -v --tb=short

test-quick: ## Executar testes rÃ¡pidos (sem calibraÃ§Ã£o)
	@echo "âš¡ Executando testes rÃ¡pidos..."
	$(PYTHON) -m pytest tests/ -v -k "not calibration" --tb=short

test-imports: ## Validar todos os imports
	@echo "ğŸ” Validando imports..."
	@$(PYTHON) -c "from app.video_processing.video_validator import VideoValidator; print('âœ… VideoValidator')"
	@$(PYTHON) -c "from app.video_processing.ocr_detector import get_ocr_detector; print('âœ… get_ocr_detector')"
	@$(PYTHON) -c "from app.infrastructure.celery_tasks import recover_orphaned_jobs; print('âœ… celery_tasks')"
	@echo "âœ… Todos os imports funcionando"

test-coverage: ## Executar testes com cobertura
	@echo "ğŸ“Š Executando testes com cobertura..."
	$(PYTHON) -m pytest tests/ --cov=app --cov-report=html --cov-report=term

# ============================================================================
# CALIBRAÃ‡ÃƒO OCR
# ============================================================================

calibrate: calibrate-start ## Executar calibraÃ§Ã£o completa (100 trials, ~60-80h)

calibrate-start: ## Iniciar calibraÃ§Ã£o em background
	@if docker ps --format "{{.Names}}" | grep -qE "calibrate|optuna|make-video-run"; then \
		echo "âš ï¸  CalibraÃ§Ã£o jÃ¡ estÃ¡ rodando!"; \
		echo "Para ver status: make calibrate-status"; \
		exit 1; \
	fi
	@echo "ğŸ¯ Iniciando CalibraÃ§Ã£o PaddleOCR"
	@echo "âš ï¸  DuraÃ§Ã£o estimada: 60-80 horas"
	@echo "âš ï¸  Trials: $(OPTUNA_TRIALS)"
	@echo ""
	@echo "ğŸš€ Iniciando..."
	@$(DOCKER_COMPOSE) run -d --rm --name calibrate_trsd_optuna \
		-v "$$(pwd)/data:/app/data:rw" \
		$(DOCKER_SERVICE) python calibrate_trsd_optuna.py
	@sleep 3
	@CONTAINER=$$(docker ps --filter "name=calibrate" --format "{{.ID}}" | head -1); \
	if [ -n "$$CONTAINER" ]; then \
		date '+%Y-%m-%d %H:%M:%S' > $(LOG_DIR)/calibration_start.txt; \
		echo ""; \
		echo "âœ… CalibraÃ§Ã£o iniciada!"; \
		echo "   Container: $$CONTAINER"; \
		echo ""; \
		echo "ğŸ“‹ Comandos Ãºteis:"; \
		echo "   make cal-status  â†’ Ver status"; \
		echo "   make cal-logs    â†’ Ver logs"; \
		echo "   make cal-watch   â†’ Monitorar"; \
		echo "   make cal-stop    â†’ Parar"; \
	else \
		echo "âŒ Erro ao iniciar calibraÃ§Ã£o"; \
		docker logs calibrate_trsd_optuna 2>&1 | tail -20; \
		exit 1; \
	fi

calibrate-quick: ## Executar calibraÃ§Ã£o rÃ¡pida (5 trials, ~3-4h)
	@echo "âš¡ Iniciando calibraÃ§Ã£o RÃPIDA (validaÃ§Ã£o)..."
	@echo "âš ï¸  DuraÃ§Ã£o estimada: 3-4 horas"
	$(DOCKER_COMPOSE) run --rm \
		-v "$$(pwd):/app:ro" \
		-v "$$(pwd)/data:/app/data:rw" \
		-e OPTUNA_TRIALS=5 \
		-e OPTUNA_TIMEOUT=600 \
		$(DOCKER_SERVICE) python calibrate_trsd_optuna.py

calibrate-status: ## Monitorar status da calibraÃ§Ã£o
	@echo "ğŸ“Š Status da CalibraÃ§Ã£o OCR - PaddleOCR"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@CONTAINERS=$$(docker ps --format "{{.Names}}	{{.Status}}	{{.ID}}" 2>/dev/null | grep -E "calibrate|optuna|make-video-run"); \
	if [ -n "$$CONTAINERS" ]; then \
		echo "âœ… CALIBRAÃ‡ÃƒO ATIVA:"; \
		echo ""; \
		NAME=$$(echo "$$CONTAINERS" | head -1 | cut -f1); \
		STATUS=$$(echo "$$CONTAINERS" | head -1 | cut -f2); \
		ID=$$(echo "$$CONTAINERS" | head -1 | cut -f3); \
		echo "   ğŸ³ Container: $$NAME"; \
		echo "   ğŸ“ ID: $$ID"; \
		echo "   â° Status: $$STATUS"; \
		echo ""; \
		STATS=$$(docker stats --no-stream --format "{{.CPUPerc}}	{{.MemUsage}}" $$ID 2>/dev/null); \
		if [ -n "$$STATS" ]; then \
			CPU=$$(echo "$$STATS" | cut -f1); \
			MEM=$$(echo "$$STATS" | cut -f2); \
			echo "   ğŸ’» CPU: $$CPU"; \
			echo "   ğŸ§  MemÃ³ria: $$MEM"; \
		fi; \
		echo ""; \
		LOGS=$$(docker logs $$ID 2>&1 | grep "Trial.*finished" | tail -3); \
		if [ -n "$$LOGS" ]; then \
			echo "   ğŸ“ˆ Ãšltimos 3 trials:"; \
			echo "$$LOGS" | sed 's/^/      /'; \
		else \
			echo "   â³ Carregando modelos PaddleOCR..."; \
		fi; \
		if [ -f $(LOG_DIR)/calibration_start.txt ]; then \
			START=$$(cat $(LOG_DIR)/calibration_start.txt); \
			echo ""; \
			echo "   ğŸ• Iniciado: $$START"; \
			START_SEC=$$(date -d "$$START" +%s 2>/dev/null || echo 0); \
			NOW_SEC=$$(date +%s); \
			if [ $$START_SEC -gt 0 ]; then \
				ELAPSED=$$((NOW_SEC - START_SEC)); \
				HOURS=$$((ELAPSED / 3600)); \
				MINS=$$(((ELAPSED % 3600) / 60)); \
				echo "   â±ï¸  Decorrido: $${HOURS}h $${MINS}m"; \
			fi; \
		fi; \
	else \
		echo "âŒ NENHUMA CALIBRAÃ‡ÃƒO RODANDO"; \
		echo ""; \
		echo "ğŸ’¡ Para iniciar:"; \
		echo "   make calibrate-start  (100 trials, ~60-80h)"; \
		echo "   make calibrate-quick  (5 trials, ~3-4h)"; \
	fi
	@echo ""
	@if [ -f $(CALIBRATION_DIR)/trsd_optuna_best_params.json ]; then \
		echo "ğŸ¯ Melhor resultado:"; \
		grep -E "min_confidence|best_accuracy|n_trials" $(CALIBRATION_DIR)/trsd_optuna_best_params.json | head -5; \
	fi
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

calibrate-logs: ## Ver logs da calibraÃ§Ã£o em tempo real
	@CONTAINER=$$(docker ps --format "{{.ID}}" 2>/dev/null | head -1); \
	CALCONTAINER=$$(docker ps --format "{{.Names}}	{{.ID}}" | grep -E "calibrate|optuna|make-video-run" | head -1 | cut -f2); \
	if [ -n "$$CALCONTAINER" ]; then \
		echo "ğŸ“‹ Logs em tempo real (Ctrl+C para sair)"; \
		echo "Container: $$CALCONTAINER"; \
		echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"; \
		docker logs -f $$CALCONTAINER 2>&1; \
	else \
		echo "âŒ CalibraÃ§Ã£o nÃ£o estÃ¡ rodando"; \
		echo "ğŸ’¡ Para iniciar: make calibrate-start"; \
	fi

calibrate-watch: ## Monitorar status continuamente (atualiza a cada 30s)
	@echo "ğŸ‘ï¸  Monitoramento contÃ­nuo (Ctrl+C para sair)"
	@echo "Atualizando a cada 30 segundos..."
	@echo ""
	@while true; do \
		clear; \
		make calibrate-status; \
		echo ""; \
		echo "ğŸ”„ PrÃ³xima atualizaÃ§Ã£o em 30s... (Ctrl+C para sair)"; \
		sleep 30; \
	done

calibrate-stop: ## Parar calibraÃ§Ã£o em execuÃ§Ã£o
	@echo "ğŸ›‘ Parando calibraÃ§Ã£o..."
	@CONTAINERS=$$(docker ps --format "{{.Names}}	{{.ID}}" | grep -E "calibrate|optuna" | cut -f2); \
	if [ -z "$$CONTAINERS" ]; then \
		CONTAINERS=$$(docker ps --format "{{.Names}}	{{.ID}}" | grep "make-video-run" | cut -f2); \
	fi; \
	if [ -n "$$CONTAINERS" ]; then \
		for CID in $$CONTAINERS; do \
			echo "  Parando container: $$CID"; \
			docker stop $$CID 2>/dev/null; \
		done; \
		rm -f $(LOG_DIR)/calibration_start.txt 2>/dev/null; \
		echo "âœ… CalibraÃ§Ã£o interrompida"; \
	else \
		echo "âŒ Nenhuma calibraÃ§Ã£o em execuÃ§Ã£o"; \
	fi

calibrate-clean: ## Limpar logs e PIDs de calibraÃ§Ã£o
	@echo "ğŸ§¹ Limpando arquivos de calibraÃ§Ã£o..."
	@rm -f $(LOG_DIR)/calibration.pid
	@rm -f $(LOG_DIR)/calibration_start.txt
	@rm -f $(LOG_DIR)/optuna_full.log
	@echo "âœ… Limpeza concluÃ­da"
	@echo "âš ï¸  Resultados em data/calibration/ foram preservados"

calibrate-apply: ## Aplicar melhor threshold encontrado ao .env
	@if [ -f $(CALIBRATION_DIR)/trsd_optuna_best_params.json ]; then \
		BEST_THRESHOLD=$$(cat $(CALIBRATION_DIR)/trsd_optuna_best_params.json | jq -r '.best_params.min_confidence'); \
		echo "ğŸ¯ Melhor threshold encontrado: $$BEST_THRESHOLD"; \
		if grep -q "OCR_CONFIDENCE_THRESHOLD=" .env 2>/dev/null; then \
			sed -i "s/OCR_CONFIDENCE_THRESHOLD=.*/OCR_CONFIDENCE_THRESHOLD=$$BEST_THRESHOLD/" .env; \
			echo "âœ… .env atualizado"; \
		else \
			echo "OCR_CONFIDENCE_THRESHOLD=$$BEST_THRESHOLD" >> .env; \
			echo "âœ… .env atualizado"; \
		fi; \
		echo "âš ï¸  NecessÃ¡rio reiniciar: make restart"; \
	else \
		echo "âŒ Nenhum resultado de calibraÃ§Ã£o encontrado"; \
		echo "ğŸ’¡ Executar calibraÃ§Ã£o primeiro: make calibrate"; \
	fi

calibrate-report: ## Mostrar relatÃ³rio completo da calibraÃ§Ã£o
	@if [ -f $(CALIBRATION_DIR)/trsd_optuna_report.md ]; then \
		cat $(CALIBRATION_DIR)/trsd_optuna_report.md; \
	else \
		echo "âŒ RelatÃ³rio nÃ£o encontrado"; \
		echo "ğŸ’¡ Executar calibraÃ§Ã£o primeiro: make calibrate-start"; \
	fi

calibrate-results: ## Mostrar todos os resultados da calibraÃ§Ã£o
	@echo "ğŸ“Š Resultados da CalibraÃ§Ã£o"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@if [ -f $(CALIBRATION_DIR)/trsd_optuna_best_params.json ]; then \
		echo "ğŸ¯ Melhores ParÃ¢metros:"; \
		cat $(CALIBRATION_DIR)/trsd_optuna_best_params.json | jq . 2>/dev/null || cat $(CALIBRATION_DIR)/trsd_optuna_best_params.json; \
		echo ""; \
	fi
	@if [ -f $(CALIBRATION_DIR)/optuna_incremental_results.json ]; then \
		echo "ğŸ“ˆ Progresso Incremental:"; \
		cat $(CALIBRATION_DIR)/optuna_incremental_results.json | jq '.best_trial' 2>/dev/null || echo "Arquivo nÃ£o Ã© JSON vÃ¡lido"; \
		echo ""; \
	fi
	@if [ -f $(CALIBRATION_DIR)/trsd_optuna_report.md ]; then \
		echo "ğŸ“„ RelatÃ³rio disponÃ­vel em: $(CALIBRATION_DIR)/trsd_optuna_report.md"; \
	fi
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# ============================================================================
# DOCKER & DEPLOYMENT
# ============================================================================

build: ## Build da imagem Docker
	@echo "ğŸ”¨ Construindo imagem Docker..."
	$(DOCKER_COMPOSE) build

up: ## Iniciar serviÃ§os em background
	@echo "ğŸš€ Iniciando serviÃ§os..."
	$(DOCKER_COMPOSE) up -d
	@echo "âœ… ServiÃ§os iniciados"
	@echo "ğŸ“Š Status: make status"
	@echo "ğŸ“‹ Logs: make logs"

down: ## Parar e remover containers
	@echo "ğŸ›‘ Parando serviÃ§os..."
	$(DOCKER_COMPOSE) down

restart: ## Reiniciar serviÃ§os
	@echo "ğŸ”„ Reiniciando serviÃ§os..."
	$(DOCKER_COMPOSE) restart
	@echo "âœ… ServiÃ§os reiniciados"

status: ## Mostrar status dos containers
	@echo "ğŸ“Š Status dos Containers"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	$(DOCKER_COMPOSE) ps
	@echo ""
	@echo "CalibraÃ§Ã£o:"
	@CALCONTAINER=$$(docker ps --format "{{.Names}}" | grep -E "calibrate|optuna|make-video-run" | head -1); \
	if [ -n "$$CALCONTAINER" ]; then \
		echo "  âœ… ATIVA: $$CALCONTAINER"; \
		echo "  Ver detalhes: make cal-status"; \
	else \
		echo "  âŒ NÃ£o rodando"; \
	fi
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

ps: status ## Alias para 'make status'

# ============================================================================
# MANUTENÃ‡ÃƒO & LIMPEZA
# ============================================================================

clean: ## Limpar arquivos temporÃ¡rios e cache
	@echo "ğŸ§¹ Limpando arquivos temporÃ¡rios..."
	find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name "*.pyc" -delete 2>/dev/null || true
	find . -type f -name "*.pyo" -delete 2>/dev/null || true
	find . -type f -name ".coverage" -delete 2>/dev/null || true
	find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true
	rm -rf htmlcov/ 2>/dev/null || true
	@echo "âœ… Limpeza concluÃ­da"

clean-storage: ## Limpar storage (âš ï¸ CUIDADO: remove vÃ­deos)
	@echo "âš ï¸  ATENÃ‡ÃƒO: Isso removerÃ¡ arquivos temporÃ¡rios do pipeline data/!"
	@echo "âœ… PRESERVADO: data/approved/videos/ e data/raw/shorts/blacklist.db"
	@read -p "Continuar? [y/N] " -n 1 -r; \
	echo; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		echo "ğŸ§¹ Limpando data/raw/audio/..."; \
		rm -rf $(RAW_DIR)/audio/* 2>/dev/null || true; \
		echo "ğŸ§¹ Limpando data/transform/..."; \
		rm -rf $(TRANSFORM_DIR)/videos/* 2>/dev/null || true; \
		rm -rf $(TRANSFORM_DIR)/temp/* 2>/dev/null || true; \
		echo "ğŸ§¹ Limpando data/validate/..."; \
		rm -rf $(VALIDATE_DIR)/in_progress/* 2>/dev/null || true; \
		rm -rf $(VALIDATE_DIR)/test_datasets/* 2>/dev/null || true; \
		echo "âœ… data/ limpo (approved/videos e blacklist.db preservados)"; \
	fi

storage-info: ## Mostrar informaÃ§Ãµes sobre o storage
	@echo "ğŸ“Š Data Pipeline Information"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo "ğŸ“‚ Estrutura:"
	@find $(DATA_DIR) -maxdepth 2 -type d | sort
	@echo ""
	@echo "ğŸ’¾ Tamanho por pasta:"
	@du -sh $(DATA_DIR)/* 2>/dev/null | sort -h
	@echo ""
	@echo "ğŸ“¹ Contagem de arquivos:"
	@echo "  raw/shorts: $$(find $(RAW_DIR)/shorts -name "*.mp4" -o -name "*.webm" 2>/dev/null | wc -l) arquivos"
	@echo "  transform/videos: $$(find $(TRANSFORM_DIR)/videos -name "*.mp4" 2>/dev/null | wc -l) vÃ­deos"
	@echo "  approved/videos: $$(find $(APPROVED_DIR)/videos -name "*.mp4" 2>/dev/null | wc -l) vÃ­deos"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

clean-all: clean ## Limpeza total (cache + containers + volumes)
	@echo "ğŸ§¹ Limpeza TOTAL..."
	$(DOCKER_COMPOSE) down -v --remove-orphans
	docker system prune -f
	@echo "âœ… Limpeza total concluÃ­da"

validate: ## Validar configuraÃ§Ã£o e estrutura
	@echo "ğŸ” Validando configuraÃ§Ã£o..."
	@echo ""
	@echo "ğŸ“‚ Estrutura de diretÃ³rios:"
	@test -d $(DATA_DIR) && echo "  âœ… data/" || echo "  âŒ data/ (criando...)" && mkdir -p $(DATA_DIR)
	@test -d $(RAW_DIR)/shorts && echo "  âœ… data/raw/shorts/" || echo "  âŒ data/raw/shorts/ (criando...)" && mkdir -p $(RAW_DIR)/shorts
	@test -d $(TRANSFORM_DIR)/videos && echo "  âœ… data/transform/videos/" || echo "  âŒ data/transform/videos/ (criando...)" && mkdir -p $(TRANSFORM_DIR)/videos
	@test -d $(VALIDATE_DIR)/in_progress && echo "  âœ… data/validate/in_progress/" || echo "  âŒ data/validate/in_progress/ (criando...)" && mkdir -p $(VALIDATE_DIR)/in_progress
	@test -d $(APPROVED_DIR)/videos && echo "  âœ… data/approved/videos/" || echo "  âŒ data/approved/videos/ (criando...)" && mkdir -p $(APPROVED_DIR)/videos
	@test -d $(CALIBRATION_DIR) && echo "  âœ… data/calibration/" || echo "  âŒ data/calibration/ (criando...)" && mkdir -p $(CALIBRATION_DIR)
	@echo ""
	@echo "ğŸ“„ Arquivos de configuraÃ§Ã£o:"
	@test -f .env && echo "  âœ… .env" || echo "  âš ï¸  .env nÃ£o encontrado"
	@test -f docker-compose.yml && echo "  âœ… docker-compose.yml" || echo "  âŒ docker-compose.yml"
	@test -f requirements.txt && echo "  âœ… requirements.txt" || echo "  âŒ requirements.txt"
	@echo ""
	@echo "ğŸ Scripts Python:"
	@test -f calibrate_trsd_optuna.py && echo "  âœ… calibrate_trsd_optuna.py" || echo "  âš ï¸  calibrate_trsd_optuna.py"
	@test -f run.py && echo "  âœ… run.py" || echo "  âŒ run.py"
	@echo ""
	@echo "âœ… ValidaÃ§Ã£o concluÃ­da"

# ============================================================================
# MONITORAMENTO
# ============================================================================

health: ## Verificar health do serviÃ§o
	@echo "ğŸ¥ Health Check"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@curl -s $(API_BASE_URL)/health 2>/dev/null | jq . || echo "âŒ ServiÃ§o nÃ£o responde ($(API_BASE_URL))"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

metrics: ## Mostrar mÃ©tricas do sistema
	@echo "ğŸ“Š MÃ©tricas do Sistema"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo "ğŸ’¾ Uso de Disco (data/):"
	@du -sh $(DATA_DIR)/* 2>/dev/null | sort -h || echo "  (vazio)"
	@echo ""
	@echo "ğŸ³ Recursos Docker:"
	@docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}" | grep make-video || echo "  ServiÃ§o nÃ£o estÃ¡ rodando"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# ============================================================================
# API CONTROLE
# ============================================================================

api-root: ## GET / (informaÃ§Ãµes do serviÃ§o)
	@curl -s $(API_BASE_URL)/ | jq .

api-openapi: ## GET /openapi.json (contrato completo da API)
	@curl -s $(API_BASE_URL)/openapi.json | jq '.info, .paths | keys'

api-health: ## GET /health
	@curl -s $(API_BASE_URL)/health | jq .

api-metrics: ## GET /metrics
	@curl -s $(API_BASE_URL)/metrics | head -40

api-download: ## POST /download (query=$(API_QUERY), max_shorts=$(API_MAX_SHORTS))
	@curl -s -X POST "$(API_BASE_URL)/download" \
		-F "query=$(API_QUERY)" \
		-F "max_shorts=$(API_MAX_SHORTS)" | jq .

api-make-video: ## POST /make-video (requer AUDIO_FILE=/caminho/audio.mp3)
	@if [ -z "$(AUDIO_FILE)" ]; then echo "âŒ Use: make api-make-video AUDIO_FILE=/path/audio.mp3"; exit 1; fi
	@curl -s -X POST "$(API_BASE_URL)/make-video" \
		-F "audio_file=@$(AUDIO_FILE)" \
		-F "query=$(API_QUERY)" \
		-F "max_shorts=$(API_MAX_SHORTS)" | jq .

api-jobs: ## GET /jobs (limit=$(API_LIMIT), status=$(API_STATUS))
	@if [ -n "$(API_STATUS)" ]; then \
		curl -s "$(API_BASE_URL)/jobs?limit=$(API_LIMIT)&status=$(API_STATUS)" | jq .; \
	else \
		curl -s "$(API_BASE_URL)/jobs?limit=$(API_LIMIT)" | jq .; \
	fi

api-job: ## GET /jobs/{job_id} (requer JOB_ID=...)
	@if [ -z "$(JOB_ID)" ]; then echo "âŒ Use: make api-job JOB_ID=<job_id>"; exit 1; fi
	@curl -s "$(API_BASE_URL)/jobs/$(JOB_ID)" | jq .

api-job-delete: ## DELETE /jobs/{job_id} (requer JOB_ID=...)
	@if [ -z "$(JOB_ID)" ]; then echo "âŒ Use: make api-job-delete JOB_ID=<job_id>"; exit 1; fi
	@curl -s -X DELETE "$(API_BASE_URL)/jobs/$(JOB_ID)" | jq .

api-download-file: ## GET /download/{job_id} (requer JOB_ID=...)
	@if [ -z "$(JOB_ID)" ]; then echo "âŒ Use: make api-download-file JOB_ID=<job_id>"; exit 1; fi
	@mkdir -p /tmp/make-video-downloads
	@curl -s -L "$(API_BASE_URL)/download/$(JOB_ID)" -o "/tmp/make-video-downloads/video_$(JOB_ID).mp4" && \
		echo "âœ… Salvo em /tmp/make-video-downloads/video_$(JOB_ID).mp4"

api-cache-stats: ## GET /cache/stats
	@curl -s "$(API_BASE_URL)/cache/stats" | jq .

api-cache-cleanup: ## POST /cache/cleanup?days=$(DAYS)
	@curl -s -X POST "$(API_BASE_URL)/cache/cleanup?days=$(DAYS)" | jq .

api-admin-stats: ## GET /admin/stats
	@curl -s "$(API_BASE_URL)/admin/stats" | jq .

api-admin-queue: ## GET /admin/queue
	@curl -s "$(API_BASE_URL)/admin/queue" | jq .

api-admin-cleanup: ## POST /admin/cleanup (deep=$(DEEP), purge=$(PURGE_CELERY_QUEUE))
	@curl -s -X POST "$(API_BASE_URL)/admin/cleanup?deep=$(DEEP)&purge_celery_queue=$(PURGE_CELERY_QUEUE)" | jq .

api-cleanup-failed: ## POST /jobs/cleanup-failed
	@curl -s -X POST "$(API_BASE_URL)/jobs/cleanup-failed" | jq .

api-orphans: ## GET /jobs/orphaned?max_age_minutes=$(MAX_AGE_MINUTES)
	@curl -s "$(API_BASE_URL)/jobs/orphaned?max_age_minutes=$(MAX_AGE_MINUTES)" | jq .

api-orphans-cleanup: ## POST /jobs/orphaned/cleanup
	@curl -s -X POST "$(API_BASE_URL)/jobs/orphaned/cleanup?max_age_minutes=$(MAX_AGE_MINUTES)&mark_as_failed=$(MARK_AS_FAILED)" | jq .

api-admin-cleanup-orphans: ## POST /admin/cleanup-orphans?max_age_minutes=$(MAX_AGE_MINUTES)
	@curl -s -X POST "$(API_BASE_URL)/admin/cleanup-orphans?max_age_minutes=$(MAX_AGE_MINUTES)" | jq .

api-smoke: ## Executa verificaÃ§Ã£o rÃ¡pida de endpoints de controle
	@echo "ğŸ” API Smoke ($(API_BASE_URL))"
	@curl -s $(API_BASE_URL)/health | jq -r '.status'
	@curl -s $(API_BASE_URL)/admin/stats | jq -r '.jobs.total'
	@curl -s $(API_BASE_URL)/cache/stats | jq . >/dev/null && echo "cache: ok"

# ============================================================================
# UTILITÃRIOS
# ============================================================================

env-check: ## Verificar variÃ¡veis de ambiente
	@echo "ğŸ” VariÃ¡veis de Ambiente"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@grep -E "^[A-Z_]+" .env 2>/dev/null | sed 's/=.*/=***/' || echo "âŒ .env nÃ£o encontrado"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

config: ## Mostrar configuraÃ§Ã£o atual
	@echo "âš™ï¸  ConfiguraÃ§Ã£o Atual"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo "ServiÃ§o: $(DOCKER_SERVICE)"
	@echo "Data: $(DATA_DIR)"
	@echo "API: $(API_BASE_URL)"
	@echo "CalibraÃ§Ã£o: $(CALIBRATION_DIR)"
	@echo "Trials (calibraÃ§Ã£o): $(OPTUNA_TRIALS)"
	@echo "Timeout (calibraÃ§Ã£o): $(OPTUNA_TIMEOUT)s"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

version: ## Mostrar versÃ£o e informaÃ§Ãµes
	@echo "â„¹ï¸  Make-Video Service"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo "VersÃ£o: 2.1"
	@echo "Python: $$($(PYTHON) --version)"
	@echo "Docker: $$(docker --version)"
	@echo "Docker Compose: $$(docker compose version)"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# ============================================================================
# ATALHOS RÃPIDOS
# ============================================================================

quick: test-quick ## Alias para 'make test-quick'

cal: calibrate ## Alias para 'make calibrate'

cal-start: calibrate-start ## Alias para 'make calibrate-start'

cal-status: calibrate-status ## Alias para 'make calibrate-status'

cal-logs: calibrate-logs ## Alias para 'make calibrate-logs'

cal-watch: calibrate-watch ## Alias para 'make calibrate-watch'

cal-stop: calibrate-stop ## Alias para 'make calibrate-stop'

cal-apply: calibrate-apply ## Alias para 'make calibrate-apply'

# ============================================================================
# DEVELOPMENT WORKFLOWS
# ============================================================================

dev-setup: install validate ## Setup completo para desenvolvimento
	@echo "âœ… Setup de desenvolvimento concluÃ­do"
	@echo ""
	@echo "PrÃ³ximos passos:"
	@echo "  1. Configurar .env: cp .env.example .env"
	@echo "  2. Iniciar serviÃ§os: make up"
	@echo "  3. Ver logs: make logs"

prod-deploy: build up ## Deploy em produÃ§Ã£o (build + up)
	@echo "âœ… Deploy concluÃ­do"
	@echo "ğŸ“Š Status: make status"

full-test: test-imports test ## Executar bateria completa de testes
	@echo "âœ… Todos os testes concluÃ­dos"
