
services:

  make-video:
    build: .
    container_name: ytcaption-make-video
    network_mode: "host"
    mem_limit: 6g
    memswap_limit: 6g
    shm_size: '2gb'
    volumes:
      # Bind mount da estrutura data/ completa (inclui data/logs/)
      - ./data:/app/data
    env_file:
      - .env
    environment:
      - PYTHONPATH=/app
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${PORT}/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  make-video-celery:
    build: .
    container_name: ytcaption-make-video-celery
    command: python -m celery -A app.infrastructure.celery_config worker --loglevel=info --concurrency=1 --queues=make_video_queue --pool=solo
    volumes:
      # Bind mount da estrutura data/ completa (inclui data/logs/)
      - ./data:/app/data
    env_file:
      - .env
    environment:
      - PYTHONPATH=/app
    extra_hosts:
      - "redis-server:192.168.1.110"
      - "youtube-search:192.168.1.110"
      - "video-downloader:192.168.1.110"
      - "audio-transcriber:192.168.1.110"
    restart: unless-stopped
    depends_on:
      make-video:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "python -m celery -A app.infrastructure.celery_config inspect ping || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - ytcaption-network

  make-video-celery-beat:
    build: .
    container_name: ytcaption-make-video-celery-beat
    command: python -m celery -A app.infrastructure.celery_config beat --loglevel=info
    env_file:
      - .env
    environment:
      - PYTHONPATH=/app
    extra_hosts:
      - "redis-server:192.168.1.110"
    restart: unless-stopped
    depends_on:
      - make-video-celery
    networks:
      - ytcaption-network

networks:
  ytcaption-network:
    external: true
    name: ytcaption-network
