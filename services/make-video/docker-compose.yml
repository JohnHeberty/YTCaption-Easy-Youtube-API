
services:

  make-video:
    build: .
    container_name: ytcaption-make-video
    ports:
      - "8004:8004"
    volumes:
      - ./storage/audio_uploads:/app/storage/audio_uploads
      - ./storage/shorts_cache:/app/storage/shorts_cache
      - ./storage/temp:/app/storage/temp
      - ./storage/output_videos:/app/storage/output_videos
      - ./logs:/app/logs
    environment:
      - PYTHONPATH=/app
      - PORT=8004
      - DEBUG=false
      - REDIS_URL=redis://192.168.1.110:6379/0
      - CACHE_TTL_HOURS=24
      - MAX_CACHE_SIZE_GB=50
      - YOUTUBE_SEARCH_URL=https://ytsearch.loadstask.com/
      - VIDEO_DOWNLOADER_URL=https://ytdownloader.loadstask.com/
      - AUDIO_TRANSCRIBER_URL=https://yttranscriber.loadstask.com/
      - AUDIO_UPLOAD_DIR=/app/storage/audio_uploads
      - SHORTS_CACHE_DIR=/app/storage/shorts_cache
      - TEMP_DIR=/app/storage/temp
      - OUTPUT_DIR=/app/storage/output_videos
      - LOG_DIR=/app/logs
      - LOG_LEVEL=INFO
      - LOG_FORMAT=json
      - DEFAULT_ASPECT_RATIO=9:16
      - DEFAULT_CROP_POSITION=center
      - DEFAULT_VIDEO_QUALITY=fast
      - CLEANUP_TEMP_AFTER_HOURS=1
      - CLEANUP_OUTPUT_AFTER_HOURS=24
      - CLEANUP_SHORTS_CACHE_AFTER_DAYS=30
      - SUBTITLE_FONT_SIZE=22
      - SUBTITLE_FONT_NAME=Arial Black
      - SUBTITLE_COLOR=&H00FFFF&
      - SUBTITLE_OUTLINE_COLOR=&H000000&
      - SUBTITLE_OUTLINE=2
      - SUBTITLE_ALIGNMENT=10
      - SUBTITLE_MARGIN_V=280
      - WORDS_PER_CAPTION=2
      - API_TIMEOUT=120
      - DOWNLOAD_POLL_INTERVAL=3
      - DOWNLOAD_MAX_POLLS=40
      - TRANSCRIBE_POLL_INTERVAL=5
      - TRANSCRIBE_MAX_POLLS=240
    extra_hosts:
      - "redis-server:192.168.1.110"
      - "youtube-search:192.168.1.110"
      - "video-downloader:192.168.1.110"
      - "audio-transcriber:192.168.1.110"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8004/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - ytcaption-network

  make-video-celery:
    build: .
    container_name: ytcaption-make-video-celery
    command: python -m celery -A app.celery_config worker --loglevel=info --concurrency=1 --queues=make_video_queue --pool=solo
    volumes:
      - ./storage/audio_uploads:/app/storage/audio_uploads
      - ./storage/shorts_cache:/app/storage/shorts_cache
      - ./storage/temp:/app/storage/temp
      - ./storage/output_videos:/app/storage/output_videos
      - ./logs:/app/logs
    environment:
      - PYTHONPATH=/app
      - PORT=8004
      - DEBUG=false
      - REDIS_URL=redis://192.168.1.110:6379/0
      - CACHE_TTL_HOURS=24
      - MAX_CACHE_SIZE_GB=50
      - YOUTUBE_SEARCH_URL=https://ytsearch.loadstask.com/
      - VIDEO_DOWNLOADER_URL=https://ytdownloader.loadstask.com/
      - AUDIO_TRANSCRIBER_URL=https://yttranscriber.loadstask.com/
      - AUDIO_UPLOAD_DIR=/app/storage/audio_uploads
      - SHORTS_CACHE_DIR=/app/storage/shorts_cache
      - TEMP_DIR=/app/storage/temp
      - OUTPUT_DIR=/app/storage/output_videos
      - LOG_DIR=/app/logs
      - LOG_LEVEL=INFO
      - LOG_FORMAT=json
      - SUBTITLE_FONT_SIZE=22
      - SUBTITLE_OUTLINE=2
      - WORDS_PER_CAPTION=2
      - API_TIMEOUT=120
      - TRANSCRIBE_MAX_POLLS=240
    extra_hosts:
      - "redis-server:192.168.1.110"
      - "youtube-search:192.168.1.110"
      - "video-downloader:192.168.1.110"
      - "audio-transcriber:192.168.1.110"
    restart: unless-stopped
    depends_on:
      make-video:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "python -m celery -A app.celery_config inspect ping || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - ytcaption-network

  make-video-celery-beat:
    build: .
    container_name: ytcaption-make-video-celery-beat
    command: python -m celery -A app.celery_config beat --loglevel=info
    environment:
      - PYTHONPATH=/app
      - REDIS_URL=redis://192.168.1.110:6379/0
      - LOG_LEVEL=INFO
    extra_hosts:
      - "redis-server:192.168.1.110"
    restart: unless-stopped
    depends_on:
      - make-video-celery
    networks:
      - ytcaption-network

networks:
  ytcaption-network:
    external: true
