# ============================================================================
# Makefile - Audio-Transcriber Service
# ============================================================================
# Comandos padronizados para desenvolvimento, testes e deploy
# 
# Uso: make <target>
# Lista de comandos: make help
# ============================================================================

.PHONY: help
.DEFAULT_GOAL := help

# ============================================================================
# VARIÃVEIS
# ============================================================================

DOCKER_COMPOSE := docker compose
DOCKER_SERVICE := audio-transcriber-celery
PYTHON := python3
VENV := .venv
VENV_BIN := $(VENV)/bin
VENV_PYTHON := $(VENV_BIN)/python
VENV_PYTEST := $(VENV_BIN)/pytest
LOG_DIR := ./logs
MODELS_DIR := ./models
UPLOADS_DIR := ./uploads
TRANSCRIPTIONS_DIR := ./transcriptions
TEMP_DIR := ./temp
API_BASE_URL := http://localhost:8003
TEST_AUDIO := tests/TEST-.ogg

# ConfiguraÃ§Ãµes
WHISPER_MODEL ?= base
WHISPER_DEVICE ?= cpu
PORT ?= 8003

# ============================================================================
# HELP
# ============================================================================

help: ## Mostrar esta mensagem de ajuda
	@echo ""
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘      Audio-Transcriber Service - Comandos DisponÃ­veis          â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | \
		awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-25s\033[0m %s\n", $$1, $$2}'
	@echo ""
	@echo "ğŸ“š Categorias:"
	@echo "  â€¢ Desenvolvimento: install, venv, dev, logs, shell"
	@echo "  â€¢ Testes: test, test-unit, test-integration, test-prod"
	@echo "  â€¢ Modelos: model-download, model-test, model-info"
	@echo "  â€¢ API: api-health, api-transcribe, api-jobs, api-languages"
	@echo "  â€¢ Deployment: network, build, up, down, restart"
	@echo "  â€¢ ManutenÃ§Ã£o: clean, clean-all, clean-models, validate"
	@echo ""
	@echo "ğŸ¯ Fluxo de Desenvolvimento:"
	@echo "  1. make install         â†’ Instalar dependÃªncias"
	@echo "  2. make model-download  â†’ Baixar modelo Whisper"
	@echo "  3. make test-prod       â†’ Testar localmente"
	@echo "  4. make build           â†’ Build containers"
	@echo "  5. make up              â†’ Subir serviÃ§o"
	@echo ""

# ============================================================================
# DESENVOLVIMENTO
# ============================================================================

venv: ## Criar virtual environment (.venv)
	@echo "ğŸ Criando virtual environment..."
	@if [ ! -d "$(VENV)" ]; then \
		$(PYTHON) -m venv $(VENV); \
		echo "âœ… Virtual environment criado: $(VENV)"; \
		echo "ğŸ’¡ Ativar: source $(VENV)/bin/activate"; \
	else \
		echo "âœ… Virtual environment jÃ¡ existe: $(VENV)"; \
	fi

install: venv ## Instalar dependÃªncias Python no venv
	@echo "ğŸ“¦ Instalando dependÃªncias no venv..."
	$(VENV_PYTHON) -m pip install --upgrade pip
	$(VENV_PYTHON) -m pip install -r requirements.txt
	@echo "âœ… DependÃªncias instaladas!"

dev: ## Rodar serviÃ§o em modo desenvolvimento (local, sem Docker)
	@echo "ğŸš€ Iniciando audio-transcriber em modo dev..."
	@echo "   Device: $(WHISPER_DEVICE)"
	@echo "   Model: $(WHISPER_MODEL)"
	@echo "   Port: $(PORT)"
	WHISPER_DEVICE=$(WHISPER_DEVICE) WHISPER_MODEL=$(WHISPER_MODEL) $(VENV_PYTHON) run.py

shell: ## Abrir shell Python com ambiente configurado
	@echo "ğŸ Abrindo Python shell..."
	$(VENV_PYTHON)

# ============================================================================
# MODELOS
# ============================================================================

model-download: venv ## Baixar modelo Whisper localmente
	@echo "ğŸ“¥ Baixando modelo Whisper: $(WHISPER_MODEL)..."
	@mkdir -p $(MODELS_DIR)
	$(VENV_PYTHON) -c "from faster_whisper import WhisperModel; WhisperModel('$(WHISPER_MODEL)', device='cpu', compute_type='int8', download_root='$(MODELS_DIR)')"
	@echo "âœ… Modelo $(WHISPER_MODEL) baixado em $(MODELS_DIR)"

model-test: venv ## Testar modelo Whisper com Ã¡udio de teste
	@echo "ğŸ¤ Testando modelo Whisper..."
	@if [ -f "$(TEST_AUDIO)" ]; then \
		$(VENV_PYTHON) test-prod/test_with_audio.py; \
	else \
		echo "âš ï¸  Ãudio de teste nÃ£o encontrado: $(TEST_AUDIO)"; \
		$(VENV_PYTHON) test-prod/test_minimal.py; \
	fi

model-info: ## Mostrar informaÃ§Ãµes dos modelos disponÃ­veis
	@echo "ğŸ“Š Modelos Faster-Whisper DisponÃ­veis:"
	@echo ""
	@echo "  Modelo    VRAM    Velocidade    Qualidade"
	@echo "  â”€â”€â”€â”€â”€â”€â”€â”€  â”€â”€â”€â”€â”€â”€  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”€â”€â”€â”€â”€â”€â”€â”€â”€"
	@echo "  tiny      ~1 GB   ~32x          â­â­"
	@echo "  base      ~1 GB   ~16x          â­â­â­"
	@echo "  small     ~2 GB   ~6x           â­â­â­â­"
	@echo "  medium    ~5 GB   ~2x           â­â­â­â­â­"
	@echo "  large     ~10GB   ~1x           â­â­â­â­â­â­"
	@echo ""
	@echo "ğŸ’¡ Modelo atual: $(WHISPER_MODEL)"
	@echo "ğŸ’¡ Device: $(WHISPER_DEVICE)"
	@echo ""
	@if [ -d "$(MODELS_DIR)" ]; then \
		echo "ğŸ“ Modelos baixados:"; \
		ls -lh $(MODELS_DIR) 2>/dev/null || echo "   (vazio)"; \
	else \
		echo "ğŸ“ DiretÃ³rio de modelos nÃ£o encontrado"; \
	fi

# ============================================================================
# TESTES
# ============================================================================

test: test-unit ## Rodar todos os testes

test-unit: venv ## Rodar testes unitÃ¡rios
	@echo "ğŸ§ª Rodando testes unitÃ¡rios..."
	$(VENV_PYTEST) tests/ -v --tb=short

test-integration: venv ## Rodar testes de integraÃ§Ã£o
	@echo "ğŸ§ª Rodando testes de integraÃ§Ã£o..."
	$(VENV_PYTEST) tests/ -v --tb=short -m integration

test-prod: venv ## Rodar testes de produÃ§Ã£o (test-prod/)
	@echo "ğŸ§ª Rodando testes de produÃ§Ã£o..."
	@if [ -d "test-prod" ]; then \
		echo "  â†’ Teste mÃ­nimo..."; \
		$(VENV_PYTHON) test-prod/test_minimal.py; \
		if [ -f "$(TEST_AUDIO)" ]; then \
			echo "  â†’ Teste com Ã¡udio..."; \
			$(VENV_PYTHON) test-prod/test_with_audio.py; \
		fi; \
	else \
		echo "âš ï¸  Pasta test-prod/ nÃ£o encontrada"; \
	fi

test-coverage: venv ## Rodar testes com cobertura
	@echo "ğŸ“Š Rodando testes com cobertura..."
	$(VENV_PYTEST) tests/ --cov=app --cov-report=html --cov-report=term
	@echo "ğŸ“„ RelatÃ³rio HTML: htmlcov/index.html"

# ============================================================================
# API - ENDPOINTS
# ============================================================================

api-health: ## Verificar saÃºde da API
	@echo "â¤ï¸  Verificando saÃºde da API..."
	@curl -s $(API_BASE_URL)/health | python3 -m json.tool || echo "âŒ API nÃ£o estÃ¡ respondendo"

api-languages: ## Listar idiomas suportados
	@echo "ğŸŒ Idiomas suportados:"
	@curl -s $(API_BASE_URL)/languages | python3 -m json.tool

api-models: ## Listar modelos disponÃ­veis
	@echo "ğŸ¤– Modelos disponÃ­veis:"
	@curl -s $(API_BASE_URL)/models | python3 -m json.tool

api-jobs: ## Listar jobs recentes
	@echo "ğŸ“‹ Jobs recentes:"
	@curl -s $(API_BASE_URL)/jobs | python3 -m json.tool

api-transcribe: ## Transcrever Ã¡udio de teste (requer TEST_AUDIO)
	@echo "ğŸ¤ Transcrevendo Ã¡udio de teste..."
	@if [ -f "$(TEST_AUDIO)" ]; then \
		curl -X POST $(API_BASE_URL)/transcribe \
			-F "audio_file=@$(TEST_AUDIO)" \
			-F "language=pt" | python3 -m json.tool; \
	else \
		echo "âš ï¸  Ãudio de teste nÃ£o encontrado: $(TEST_AUDIO)"; \
	fi

# ============================================================================
# DOCKER - BUILD & DEPLOY
# ============================================================================

network: ## Criar rede Docker compartilhada
	@echo "ğŸŒ Criando rede Docker..."
	@docker network create ytcaption_network 2>/dev/null || echo "âœ… Rede jÃ¡ existe"

build: ## Build das imagens Docker
	@echo "ğŸ”¨ Building audio-transcriber..."
	$(DOCKER_COMPOSE) build

build-no-cache: ## Build sem cache (fresh build)
	@echo "ğŸ”¨ Building audio-transcriber (no cache)..."
	$(DOCKER_COMPOSE) build --no-cache

up: network ## Subir serviÃ§o em background
	@echo "ğŸš€ Subindo audio-transcriber..."
	$(DOCKER_COMPOSE) up -d
	@echo ""
	@echo "âœ… ServiÃ§o iniciado!"
	@echo "   API: $(API_BASE_URL)"
	@echo "   Logs: make logs"
	@echo "   Health: make api-health"

down: ## Parar e remover containers
	@echo "ğŸ›‘ Parando audio-transcriber..."
	$(DOCKER_COMPOSE) down

restart: down up ## Reiniciar serviÃ§o

logs: ## Mostrar logs do serviÃ§o
	@echo "ğŸ“œ Logs do audio-transcriber..."
	$(DOCKER_COMPOSE) logs -f --tail=100 $(DOCKER_SERVICE)

logs-api: ## Mostrar logs da API
	@echo "ğŸ“œ Logs da API..."
	$(DOCKER_COMPOSE) logs -f --tail=100 audio-transcriber-service

logs-celery: ## Mostrar logs do Celery
	@echo "ğŸ“œ Logs do Celery..."
	$(DOCKER_COMPOSE) logs -f --tail=100 audio-transcriber-celery

ps: ## Mostrar status dos containers
	@echo "ğŸ“Š Status dos containers:"
	$(DOCKER_COMPOSE) ps

exec-api: ## Executar bash no container da API
	@echo "ğŸš Abrindo shell no container da API..."
	docker exec -it audio-transcriber-api /bin/bash

exec-celery: ## Executar bash no container do Celery
	@echo "ğŸš Abrindo shell no container do Celery..."
	docker exec -it audio-transcriber-celery /bin/bash

# ============================================================================
# MANUTENÃ‡ÃƒO
# ============================================================================

clean: ## Limpar arquivos temporÃ¡rios e cache
	@echo "ğŸ§¹ Limpando arquivos temporÃ¡rios..."
	find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name .pytest_cache -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name .coverage -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name "*.pyc" -delete 2>/dev/null || true
	find . -type f -name "*.pyo" -delete 2>/dev/null || true
	find . -type f -name ".DS_Store" -delete 2>/dev/null || true
	@echo "âœ… Cache limpo!"

clean-uploads: ## Limpar arquivos de upload
	@echo "ğŸ§¹ Limpando uploads..."
	@if [ -d "$(UPLOADS_DIR)" ]; then \
		rm -rf $(UPLOADS_DIR)/*; \
		echo "âœ… Uploads limpos!"; \
	else \
		echo "âš ï¸  DiretÃ³rio de uploads nÃ£o encontrado"; \
	fi

clean-transcriptions: ## Limpar transcriÃ§Ãµes antigas
	@echo "ğŸ§¹ Limpando transcriÃ§Ãµes..."
	@if [ -d "$(TRANSCRIPTIONS_DIR)" ]; then \
		find $(TRANSCRIPTIONS_DIR) -type f -mtime +7 -delete; \
		echo "âœ… TranscriÃ§Ãµes antigas removidas (>7 dias)"; \
	else \
		echo "âš ï¸  DiretÃ³rio de transcriÃ§Ãµes nÃ£o encontrado"; \
	fi

clean-models: ## Remover modelos baixados (CUIDADO!)
	@echo "âš ï¸  ATENÃ‡ÃƒO: Isso removerÃ¡ todos os modelos baixados!"
	@read -p "Continuar? [y/N] " -n 1 -r; \
	echo; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		rm -rf $(MODELS_DIR)/*; \
		echo "âœ… Modelos removidos!"; \
	else \
		echo "âŒ OperaÃ§Ã£o cancelada"; \
	fi

clean-all: clean clean-uploads clean-transcriptions ## Limpar tudo (exceto modelos)
	@echo "ğŸ§¹ Limpando Docker..."
	$(DOCKER_COMPOSE) down -v
	@echo "âœ… Limpeza completa!"

validate: ## Validar configuraÃ§Ãµes e dependÃªncias
	@echo "âœ… Validando configuraÃ§Ãµes..."
	@echo ""
	@echo "ğŸ“ DiretÃ³rios:"
	@mkdir -p $(LOG_DIR) $(MODELS_DIR) $(UPLOADS_DIR) $(TRANSCRIPTIONS_DIR) $(TEMP_DIR)
	@ls -ld $(LOG_DIR) $(MODELS_DIR) $(UPLOADS_DIR) $(TRANSCRIPTIONS_DIR) $(TEMP_DIR)
	@echo ""
	@echo "ğŸ Python:"
	@$(VENV_PYTHON) --version
	@echo ""
	@echo "ğŸ“¦ Faster-Whisper:"
	@$(VENV_PYTHON) -c "import faster_whisper; print(f'  Version: {faster_whisper.__version__}')" 2>/dev/null || echo "  âš ï¸  NÃ£o instalado"
	@echo ""
	@echo "ğŸ³ Docker:"
	@docker --version
	@$(DOCKER_COMPOSE) --version
	@echo ""
	@echo "âœ… ValidaÃ§Ã£o completa!"

# ============================================================================
# PRODUÃ‡ÃƒO
# ============================================================================

prod-build: ## Build otimizado para produÃ§Ã£o
	@echo "ğŸ­ Building para produÃ§Ã£o..."
	DOCKER_BUILDKIT=1 $(DOCKER_COMPOSE) build --build-arg BUILD_ENV=production

prod-up: network prod-build ## Deploy em produÃ§Ã£o
	@echo "ğŸš€ Deploying em produÃ§Ã£o..."
	$(DOCKER_COMPOSE) up -d
	@echo ""
	@echo "âœ… ProduÃ§Ã£o iniciada!"
	@make api-health

prod-logs: ## Logs de produÃ§Ã£o (Ãºltimas 500 linhas)
	@echo "ğŸ“œ Logs de produÃ§Ã£o..."
	$(DOCKER_COMPOSE) logs --tail=500 $(DOCKER_SERVICE)

prod-status: ## Status de produÃ§Ã£o
	@echo "ğŸ“Š Status de ProduÃ§Ã£o:"
	@echo ""
	@make ps
	@echo ""
	@make api-health

# ============================================================================
# DIAGNÃ“STICO
# ============================================================================

diagnose: ## DiagnÃ³stico completo do sistema
	@echo "ğŸ” DiagnÃ³stico do Audio-Transcriber..."
	@echo ""
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo "1. AMBIENTE"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@make validate
	@echo ""
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo "2. DOCKER"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@make ps
	@echo ""
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo "3. API"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@make api-health
	@echo ""
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo "4. MODELOS"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@make model-info
	@echo ""
	@echo "âœ… DiagnÃ³stico completo!"

info: ## InformaÃ§Ãµes do serviÃ§o
	@echo ""
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘              Audio-Transcriber Service Info                    â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "ğŸ™ï¸  ServiÃ§o: Audio Transcription com Faster-Whisper"
	@echo "ğŸ”§ Tecnologias: FastAPI + Celery + Faster-Whisper + Redis"
	@echo "ğŸŒ API Port: $(PORT)"
	@echo "ğŸ¤– Modelo: $(WHISPER_MODEL)"
	@echo "ğŸ’» Device: $(WHISPER_DEVICE)"
	@echo ""
	@echo "ğŸ“ DiretÃ³rios:"
	@echo "  â€¢ Modelos: $(MODELS_DIR)"
	@echo "  â€¢ Uploads: $(UPLOADS_DIR)"
	@echo "  â€¢ TranscriÃ§Ãµes: $(TRANSCRIPTIONS_DIR)"
	@echo "  â€¢ Logs: $(LOG_DIR)"
	@echo ""
	@echo "ğŸ”— Endpoints:"
	@echo "  â€¢ Health: $(API_BASE_URL)/health"
	@echo "  â€¢ Docs: $(API_BASE_URL)/docs"
	@echo "  â€¢ Transcribe: $(API_BASE_URL)/transcribe"
	@echo ""

.PHONY: venv install dev shell model-download model-test model-info \
        test test-unit test-integration test-prod test-coverage \
        api-health api-languages api-models api-jobs api-transcribe \
        network build build-no-cache up down restart \
        logs logs-api logs-celery ps exec-api exec-celery \
        clean clean-uploads clean-transcriptions clean-models clean-all validate \
        prod-build prod-up prod-logs prod-status \
        diagnose info
